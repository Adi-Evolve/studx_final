<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudXchange Admin Panel - Complete Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ“</text></svg>">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .login-logo .subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .login-form .form-control {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .login-form .btn {
            padding: 12px;
            border-radius: 5px;
            width: 100%;
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Main Content Styles */
        #mainContent {
            display: none;
        }

        .sidebar {
            background-color: var(--dark-bg);
            min-height: 100vh;
            padding: 20px;
            color: white;
            position: fixed;
            width: 250px;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
            padding: 10px 15px;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        /* Card Styles */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .delete-product-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            z-index: 10;
        }

        .delete-product-btn:hover {
            background-color: var(--danger-color);
            transform: scale(1.1);
        }

        /* Loading spinner animation */
        .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <div class="login-logo">
            <h1>StudX Admin</h1>
        </div>
        <form id="loginForm" class="login-form">
            <div class="mb-3">
                <input type="text" class="form-control" id="username" placeholder="Username" required>
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
            <div id="errorMessage" class="error-message">Invalid username or password</div>
        </form>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <h3 class="mb-4">StudX Admin</h3>
            <nav class="nav flex-column">
                <a href="#" class="nav-link active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                </a>
                <a href="#" class="nav-link" data-page="products">
                    <i class="fas fa-box me-2"></i> Products
                </a>
                <a href="#" class="nav-link" data-page="users">
                    <i class="fas fa-users me-2"></i> Users
                </a>
                <a href="#" class="nav-link" data-page="settings">
                    <i class="fas fa-cog me-2"></i> Settings
                </a>
                <a href="#" class="nav-link text-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div id="content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
(async function() {
    // SUPABASE CONFIG
    const SUPABASE_URL = 'https://vdpmumstdxgftaaxeacx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkcG11bXN0ZHhnZnRhYXhlYWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MDYwODIsImV4cCI6MjA2NzQ4MjA4Mn0.Pbfm3FebzjQAHLPfdkzky-IH9aF3Zj1ZNVBjwe-3lyw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Check login status
    function checkLogin() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const rememberMe = localStorage.getItem('rememberMe');
        
        if (isLoggedIn === 'true' && rememberMe === 'true') {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadPage('dashboard');
            attachSidebarHandlers();
        } else {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
    }

    // Handle login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;

        // Simple demo login - accept any credentials
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        if (rememberMe) {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('savedUsername', username);
        }
        
        loadPage('dashboard');
        attachSidebarHandlers();
    });

    // Attach sidebar navigation handlers
    function attachSidebarHandlers() {
        document.querySelectorAll('.nav-link[data-page]').forEach(link => {
            link.onclick = function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                loadPage(page);
            };
        });
        
        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.onclick = function(e) {
                e.preventDefault();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('rememberMe');
                localStorage.removeItem('savedUsername');
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
            };
        }
    }

    // Function to load page content
    function loadPage(page) {
        const contentDiv = document.getElementById('content');
        
        // Update active link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-page') === page) {
                link.classList.add('active');
            }
        });

        if (page === 'dashboard') {
            contentDiv.innerHTML = `
                <div class="dashboard-container">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-box fa-2x me-3"></i>
                                        <div>
                                            <h5>Products</h5>
                                            <h3 id="productsCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-sticky-note fa-2x me-3"></i>
                                        <div>
                                            <h5>Notes</h5>
                                            <h3 id="notesCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-home fa-2x me-3"></i>
                                        <div>
                                            <h5>Rooms</h5>
                                            <h3 id="roomsCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-users fa-2x me-3"></i>
                                        <div>
                                            <h5>Users</h5>
                                            <h3 id="usersCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-cog"></i> Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="loadPage('products')">
                                            <i class="fas fa-box"></i> Manage Products
                                        </button>
                                        <button class="btn btn-outline-success" onclick="loadPage('users')">
                                            <i class="fas fa-users"></i> Manage Users
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="loadPage('settings')">
                                            <i class="fas fa-cog"></i> Settings
                                        </button>
                                        <button class="btn btn-outline-info" onclick="window.open('https://studxchange.vercel.app', '_blank')">
                                            <i class="fas fa-external-link-alt"></i> Open StudXchange Site
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-globe"></i> StudXchange Preview</h5>
                                </div>
                                <div class="card-body p-0">
                                    <iframe 
                                        src="https://studxchange.vercel.app" 
                                        width="100%" 
                                        height="400" 
                                        frameborder="0" 
                                        style="border-radius: 0 0 10px 10px;"
                                        title="StudXchange Preview">
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderDashboard();
        } else if (page === 'products') {
            contentDiv.innerHTML = `
                <div class="products-header mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h2><i class="fas fa-box"></i> Products Management</h2>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <select id="sortSelect" class="form-select" style="width: auto;">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="name">Name A-Z</option>
                                    <option value="type">Type</option>
                                </select>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-danger" id="bulkDeleteBtn" disabled>
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                    <button class="btn btn-outline-secondary" id="selectAllBtn">
                                        <i class="fas fa-check-square"></i> Select All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class='mb-3'>
                    <input type='text' id='productSearch' class='form-control' placeholder='Search products, rooms, notes...'>
                </div>
                <div id='productCards' class='row g-3'></div>
            `;
            renderProductsPage();
        } else if (page === 'users') {
            contentDiv.innerHTML = `<h2><i class="fas fa-users"></i> Users Management</h2><div id='usersTable'></div>`;
            renderUsersPage();
        } else if (page === 'settings') {
            contentDiv.innerHTML = `
                <div class='container py-4'>
                    <h2><i class="fas fa-cog"></i> Admin Settings</h2>
                    <div class='alert alert-info'>
                        <i class="fas fa-info-circle"></i> Settings functionality coming soon. This is a demo admin panel.
                    </div>
                </div>
            `;
        } else {
            contentDiv.innerHTML = `<div class="alert alert-danger">Unknown page: ${page}</div>`;
        }
    }

    // Dashboard: Load statistics
    async function renderDashboard() {
        try {
            const [
                { count: productsCount },
                { count: notesCount },
                { count: roomsCount },
                { count: usersCount }
            ] = await Promise.all([
                supabase.from('products').select('*', { count: 'exact', head: true }),
                supabase.from('notes').select('*', { count: 'exact', head: true }),
                supabase.from('rooms').select('*', { count: 'exact', head: true }),
                supabase.from('users').select('*', { count: 'exact', head: true })
            ]);

            document.getElementById('productsCount').textContent = productsCount || 0;
            document.getElementById('notesCount').textContent = notesCount || 0;
            document.getElementById('roomsCount').textContent = roomsCount || 0;
            document.getElementById('usersCount').textContent = usersCount || 0;
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // Products Page: Fetch all items and render as cards
    async function renderProductsPage() {
        let allItems = [];
        let selectedItems = new Set();
        
        try {
            const [{ data: products = [] } = {}, { data: notes = [] } = {}, { data: rooms = [] } = {}] = await Promise.all([
                supabase.from('products').select('*').order('created_at', { ascending: false }).throwOnError(false),
                supabase.from('notes').select('*').order('created_at', { ascending: false }).throwOnError(false),
                supabase.from('rooms').select('*').order('created_at', { ascending: false }).throwOnError(false)
            ]);
            
            products.forEach(p => p._type = 'product');
            notes.forEach(n => n._type = 'note');
            rooms.forEach(r => r._type = 'room');
            allItems = [...products, ...notes, ...rooms];
            
            // Sort all items by created_at in descending order (newest first)
            allItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } catch (err) {
            document.getElementById('productCards').innerHTML = `<div class='alert alert-danger'>Failed to load items: ${err.message}</div>`;
            return;
        }

        function updateBulkButtons() {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = selectedItems.size === 0;
                bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedItems.size})`;
            }
            
            if (selectAllBtn) {
                const allSelected = selectedItems.size === allItems.length;
                selectAllBtn.innerHTML = allSelected ? 
                    '<i class="fas fa-square"></i> Deselect All' : 
                    '<i class="fas fa-check-square"></i> Select All';
            }
        }

        function renderCards(filter = '', sortBy = 'newest') {
            let filtered = allItems.filter(item => {
                const search = filter.toLowerCase();
                return Object.values(item).join(' ').toLowerCase().includes(search);
            });
            
            // Sort filtered items based on sortBy parameter
            switch(sortBy) {
                case 'newest':
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'name':
                    filtered.sort((a, b) => {
                        const nameA = (a.title || a.name || '').toLowerCase();
                        const nameB = (b.title || b.name || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'type':
                    filtered.sort((a, b) => a._type.localeCompare(b._type));
                    break;
            }
            
            if (!filtered.length) {
                document.getElementById('productCards').innerHTML = `<div class='alert alert-info'>No items found.</div>`;
                return;
            }
            
            document.getElementById('productCards').innerHTML = filtered.map(item => {
                let imgSrc = item.image || item.image_url || item.img || (item.images && Array.isArray(item.images) && item.images.length > 0 ? item.images[0] : '');
                let imgTag = imgSrc ? `<img src='${imgSrc}' alt='Image' class='card-img-top' style='object-fit:cover;height:180px;'>` : `<div style='height:180px;background:#eee;display:flex;align-items:center;justify-content:center;color:#aaa;'>No Image</div>`;
                const isSelected = selectedItems.has(item.id);
                
                return `
                <div class='col-md-4'>
                    <div class='card product-card h-100 position-relative ${isSelected ? 'border-primary' : ''}' style='cursor:pointer;' data-id='${item.id}' data-type='${item._type}'>
                        <div class="form-check position-absolute" style="top: 10px; left: 10px; z-index: 10;">
                            <input class="form-check-input item-checkbox" type="checkbox" data-id="${item.id}" ${isSelected ? 'checked' : ''}>
                        </div>
                        <button class='btn btn-sm btn-danger delete-product-btn' data-id='${item.id}' data-type='${item._type}' title='Delete'>&times;</button>
                        ${imgTag}
                        <div class='card-body'>
                            <h5 class='card-title'>${item.title || item.name || '(no title)'}</h5>
                            <p class='card-text'><b>Type:</b> <span class="badge bg-secondary">${item._type}</span></p>
                            <p class='card-text'><b>ID:</b> ${item.id}</p>
                            <p class='card-text'><b>Created:</b> ${new Date(item.created_at).toLocaleDateString()} <small class="text-muted">(${getRelativeTime(item.created_at)})</small></p>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Add checkbox handlers
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    const id = checkbox.getAttribute('data-id');
                    if (checkbox.checked) {
                        selectedItems.add(id);
                    } else {
                        selectedItems.delete(id);
                    }
                    updateBulkButtons();
                    renderCards(filter);
                };
            });
            
            // Add individual delete handlers
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) return;
                    
                    const id = btn.getAttribute('data-id');
                    const type = btn.getAttribute('data-type');
                    let table = type === 'note' ? 'notes' : (type === 'room' ? 'rooms' : 'products');
                    
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;
                    
                    try {
                        const { error } = await supabase.from(table).delete().eq('id', id);
                        if (error) {
                            alert('Failed to delete: ' + error.message);
                            btn.innerHTML = '&times;';
                            btn.disabled = false;
                            return;
                        }
                        
                        const itemIndex = allItems.findIndex(item => item.id === id && item._type === type);
                        if (itemIndex !== -1) {
                            allItems.splice(itemIndex, 1);
                        }
                        
                        selectedItems.delete(id);
                        const searchValue = document.getElementById('productSearch')?.value || '';
                        const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                        renderCards(searchValue, sortValue);
                        alert('Item deleted successfully!');
                    } catch (err) {
                        alert('Error deleting item: ' + err.message);
                        btn.innerHTML = '&times;';
                        btn.disabled = false;
                    }
                };
            });
            
            updateBulkButtons();
        }

        // Helper function to get relative time
        function getRelativeTime(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) return 'just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return `${Math.floor(diffInSeconds / 2592000)}mo ago`;
        }

        renderCards();
        
        // Setup sorting
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                const searchValue = document.getElementById('productSearch')?.value || '';
                renderCards(searchValue, e.target.value);
            });
        }
        
        // Setup bulk operations
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        
        if (bulkDeleteBtn) {
            bulkDeleteBtn.onclick = async () => {
                if (selectedItems.size === 0) return;
                
                if (!confirm(`Are you sure you want to delete ${selectedItems.size} items? This action cannot be undone.`)) return;
                
                bulkDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                bulkDeleteBtn.disabled = true;
                
                try {
                    const promises = [];
                    selectedItems.forEach(id => {
                        const item = allItems.find(i => i.id === id);
                        if (item) {
                            const table = item._type === 'note' ? 'notes' : (item._type === 'room' ? 'rooms' : 'products');
                            promises.push(supabase.from(table).delete().eq('id', id));
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    allItems = allItems.filter(item => !selectedItems.has(item.id));
                    selectedItems.clear();
                    
                    const searchValue = document.getElementById('productSearch')?.value || '';
                    const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                    renderCards(searchValue, sortValue);
                    alert('Items deleted successfully!');
                } catch (error) {
                    alert('Error deleting items: ' + error.message);
                }
                
                bulkDeleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete Selected';
                bulkDeleteBtn.disabled = true;
            };
        }
        
        if (selectAllBtn) {
            selectAllBtn.onclick = () => {
                const allSelected = selectedItems.size === allItems.length;
                if (allSelected) {
                    selectedItems.clear();
                } else {
                    allItems.forEach(item => selectedItems.add(item.id));
                }
                updateBulkButtons();
                const searchValue = document.getElementById('productSearch')?.value || '';
                const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                renderCards(searchValue, sortValue);
            };
        }
        
        // Search functionality
        const searchInput = document.getElementById('productSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                renderCards(e.target.value, sortValue);
            });
        }
    }

    // Users Page: Fetch all users from users table
    async function renderUsersPage() {
        try {
            const { data: users = [], error } = await supabase.from('users').select('*');
            if (error) throw error;
            
            if (!users.length) {
                document.getElementById('usersTable').innerHTML = `<div class='alert alert-info'>No users found.</div>`;
                return;
            }
            
            document.getElementById('usersTable').innerHTML = `
                <div class='table-responsive'>
                    <table class='table table-striped'>
                        <thead>
                            <tr>
                                ${Object.keys(users[0]).map(k => `<th>${k}</th>`).join('')}
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr id='user-row-${u.id}'>
                                    ${Object.values(u).map(v => `<td>${v || 'N/A'}</td>`).join('')}
                                    <td>
                                        <button class='btn btn-sm btn-danger delete-user-btn' data-id='${u.id}'>
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add delete handlers
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
                    
                    const id = btn.getAttribute('data-id');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;
                    
                    try {
                        const { error } = await supabase.from('users').delete().eq('id', id);
                        if (error) {
                            alert('Failed to delete user: ' + error.message);
                            btn.innerHTML = 'Delete';
                            btn.disabled = false;
                            return;
                        }
                        
                        const row = document.getElementById(`user-row-${id}`);
                        if (row) {
                            row.remove();
                        }
                        
                        alert('User deleted successfully!');
                        
                        const tableBody = document.querySelector('#usersTable tbody');
                        if (tableBody && tableBody.children.length === 0) {
                            document.getElementById('usersTable').innerHTML = `<div class='alert alert-info'>No users found.</div>`;
                        }
                    } catch (err) {
                        alert('Error deleting user: ' + err.message);
                        btn.innerHTML = 'Delete';
                        btn.disabled = false;
                    }
                };
            });
        } catch (err) {
            document.getElementById('usersTable').innerHTML = `<div class='alert alert-danger'>Failed to load users: ${err.message}</div>`;
        }
    }

    // Initialize
    checkLogin();
})();
    </script>
</body>
</html>
