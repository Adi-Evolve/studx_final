<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudXchange Admin Panel - Complete Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ“</text></svg>">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 0.5rem;
            --border-radius-sm: 0.25rem;
            --border-radius-lg: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Modern Login Container */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 3rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .login-logo .subtitle {
            color: var(--secondary-color);
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        /* Modern Form Styles */
        .form-control {
            background: var(--light-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 1rem;
            display: none;
            padding: 0.75rem;
            background: rgba(220, 38, 38, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        /* Main Content Styles */
        #mainContent {
            display: none;
        }

        /* Modern Sidebar */
        .sidebar {
            background: white;
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            padding: 2rem 0;
            box-shadow: var(--shadow-lg);
            border-right: 1px solid var(--border-color);
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .sidebar h3 {
            color: var(--primary-color);
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-subtitle {
            color: var(--secondary-color);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        /* Modern Navigation */
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 2rem;
            color: var(--secondary-color);
            text-decoration: none;
            transition: all 0.2s ease;
            font-weight: 500;
            border-left: 3px solid transparent;
            position: relative;
            margin: 0;
        }

        .nav-link:hover {
            background: var(--light-color);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .nav-link.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        /* Modern Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: var(--light-color);
            padding: 2rem;
        }

        /* Modern Cards */
        .card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Modern Metrics Cards */
        .metric-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--secondary-color);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Color Variants for Metrics */
        .metric-primary { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
        .metric-success { background: rgba(5, 150, 105, 0.1); color: var(--success-color); }
        .metric-warning { background: rgba(217, 119, 6, 0.1); color: var(--warning-color); }
        .metric-danger { background: rgba(220, 38, 38, 0.1); color: var(--danger-color); }

        .product-card {
            transition: all 0.2s ease;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .delete-product-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            z-index: 10;
            background: var(--danger-color);
            color: white;
            border: none;
            transition: all 0.2s ease;
        }

        .delete-product-btn:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }

        /* Modern Tables */
        .table {
            background: white;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table th {
            background: var(--light-color);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table tr:hover {
            background: var(--light-color);
        }

        /* Modern Buttons */
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-success { 
            background: var(--success-color); 
            color: white; 
            border: none;
        }

        .btn-warning { 
            background: var(--warning-color); 
            color: white; 
            border: none;
        }

        .btn-danger { 
            background: var(--danger-color); 
            color: white; 
            border: none;
        }

        .btn-secondary { 
            background: var(--secondary-color); 
            color: white; 
            border: none;
        }

        /* Advanced UI Enhancements */
        .dark-mode {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #94a3b8;
            --dark-color: #f1f5f9;
            --light-color: #1e293b;
            --border-color: #334155;
            background: #0f172a;
            color: #f1f5f9;
        }

        .dark-mode .sidebar {
            background: #1e293b;
            border-right: 1px solid #334155;
        }

        .dark-mode .nav-link {
            color: #cbd5e1;
        }

        .dark-mode .nav-link:hover {
            background: #334155;
        }

        .dark-mode .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .dark-mode .card {
            background: #1e293b;
            border: 1px solid #334155;
            color: #f1f5f9;
        }

        .dark-mode .table th {
            background: #334155;
            color: #f1f5f9;
        }

        .dark-mode .form-control {
            background: #334155;
            border: 1px solid #475569;
            color: #f1f5f9;
        }

        .dark-mode .form-control:focus {
            background: #475569;
            border-color: var(--primary-color);
            color: #f1f5f9;
        }

        /* Dark mode modal and additional component styles */
        .dark-mode .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            color: #f1f5f9;
        }

        .dark-mode .modal-header {
            border-bottom: 1px solid #334155;
        }

        .dark-mode .modal-footer {
            border-top: 1px solid #334155;
        }

        .dark-mode .form-select {
            background: #334155;
            border: 1px solid #475569;
            color: #f1f5f9;
        }

        .dark-mode .alert {
            border: 1px solid #334155;
        }

        .dark-mode .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #93c5fd;
        }

        .dark-mode .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #86efac;
        }

        .dark-mode .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #fca5a5;
        }

        .dark-mode .text-muted {
            color: #94a3b8 !important;
        }

        .dark-mode .item-card {
            background: #1e293b;
            border: 1px solid #334155;
            color: #f1f5f9;
        }

        .dark-mode .sponsor-slot {
            background: #334155;
            border: 2px dashed #475569 !important;
        }

        .dark-mode .sponsor-slot.drag-over {
            border-color: var(--primary-color) !important;
            background: rgba(59, 130, 246, 0.1);
        }

        .dark-mode .sponsored-item {
            background: #1e293b;
            border: 1px solid #334155;
            color: #f1f5f9;
        }

        .dark-mode .btn-outline-secondary {
            border-color: #64748b;
            color: #64748b;
        }

        .dark-mode .btn-outline-secondary:hover {
            background: #64748b;
            border-color: #64748b;
            color: white;
        }

        .dark-mode .btn-outline-danger {
            border-color: #ef4444;
            color: #ef4444;
        }

        .dark-mode .btn-outline-danger:hover {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        .dark-mode .table-striped > tbody > tr:nth-of-type(odd) > td,
        .dark-mode .table-striped > tbody > tr:nth-of-type(odd) > th {
            background: #334155;
        }

        .dark-mode .table {
            color: #f1f5f9;
        }

        .dark-mode .badge {
            color: white;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        /* Search Enhancement */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            pointer-events: none;
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        /* Success/Error Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Advanced Tables */
        .table-container {
            background: white;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .table-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-active {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success-color);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-pending {
            background: rgba(217, 119, 6, 0.1);
            color: var(--warning-color);
        }

        /* Modern Form Controls */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Quick Actions Panel */
        .quick-actions {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 2rem;
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.25rem;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        /* Advanced Grid System */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .admin-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .admin-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }

            .metric-card {
                margin-bottom: 1rem;
            }

            .admin-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Animation Utilities */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Mobile Header */
        .mobile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .mobile-menu-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--dark-color);
            cursor: pointer;
        }

        /* Page Header */
        .page-header {
            padding: 1.5rem 2rem 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .content-area {
            padding: 0 2rem 2rem;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Modern Form Elements */
        .form-select {
            background: var(--light-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Modern Badges */
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* Modern Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid transparent;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
            color: #1d4ed8;
        }

        .alert-success {
            background: rgba(5, 150, 105, 0.1);
            border-color: rgba(5, 150, 105, 0.2);
            color: var(--success-color);
        }

        .alert-danger {
            background: rgba(220, 38, 38, 0.1);
            border-color: rgba(220, 38, 38, 0.2);
            color: var(--danger-color);
        }

        /* Modern Sponsorship Redesign */
        .sponsorship-container {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* Gradient Button */
        .btn-gradient-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .btn-gradient-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Modern Stat Cards */
        .stat-card {
            border-radius: 20px;
            padding: 30px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-gradient-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .bg-gradient-info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .bg-gradient-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }

        .stat-icon {
            font-size: 3rem;
            opacity: 0.8;
            float: right;
            margin-top: -10px;
        }

        .stat-content h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0 5px 0;
        }

        .stat-content p {
            font-size: 1.1rem;
            margin: 0;
            opacity: 0.9;
        }

        .stat-trend {
            font-size: 0.9rem;
            margin-top: 8px;
            opacity: 0.8;
        }

        /* Modern Cards */
        .modern-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .modern-card:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card-header-modern {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .card-body-modern {
            padding: 25px;
        }

        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            color: white;
        }

        .quick-action-btn i {
            font-size: 1.5rem;
        }

        /* Sponsorship Grid */
        .sponsorship-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            min-height: 400px;
        }

        .sponsor-item-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: move;
            border: 2px solid transparent;
        }

        .sponsor-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .sponsor-item-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .spinner-sm {
            width: 30px;
            height: 30px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Performance List */
        .performance-list {
            min-height: 200px;
        }

        .performance-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .performance-item:last-child {
            border-bottom: none;
        }

        .performance-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        /* Enhanced Modal Styles */
        .modern-modal {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.3rem;
        }

        .btn-close-modern {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .btn-close-modern:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .modal-body-modern {
            padding: 30px;
        }

        .modal-footer-modern {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
        }

        /* Search Panel */
        .search-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-box input {
            padding-left: 45px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .modern-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .modern-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-header h6 {
            margin: 0;
            font-weight: 600;
            color: #495057;
        }

        /* Items Grid */
        .items-grid {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .items-grid::-webkit-scrollbar {
            width: 8px;
        }

        .items-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .items-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .item-card.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .item-card.sponsored {
            border-color: #ffc107;
            background-color: #fff9e6;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .item-card.sponsored:hover {
            transform: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-color: #ffc107;
        }

        .sponsored-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            z-index: 10;
        }

        /* Sponsor Slots Container */
        .sponsor-slots-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-height: 500px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .sponsor-slots-container.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .empty-slots {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .empty-slots i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .slot-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .slot-number {
            background: rgba(255,255,255,0.2);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sponsorship-container {
                padding: 15px;
            }
            
            .stat-card {
                margin-bottom: 20px;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .sponsorship-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-body-modern {
                padding: 20px;
            }
        }

        /* Loading Placeholder */
        .loading-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        /* Enhanced Sponsorship Modal Styles */
        .modal-items-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .item-card {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .item-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }

        .item-card.selected {
            border-color: var(--success-color);
            background: rgba(5, 150, 105, 0.1);
        }

        .item-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .sponsor-slots {
            min-height: 400px;
            background: var(--light-color);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .sponsor-slot {
            min-height: 80px;
            border: 2px dashed var(--secondary-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            position: relative;
            transition: all 0.2s ease;
        }

        .sponsor-slot:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .sponsor-slot.drag-over {
            border-color: var(--success-color);
            background: rgba(5, 150, 105, 0.1);
            transform: scale(1.02);
        }

        .sponsor-slot .slot-number {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .sponsor-slot .slot-content {
            padding-top: 10px;
        }

        .sponsored-item {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .sponsored-item:hover {
            background: var(--border-color);
        }

        .remove-sponsor {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }

        /* Drag and Drop States */
        .draggable {
            cursor: move;
        }

        .draggable:active {
            cursor: grabbing;
        }

        .drop-zone {
            transition: all 0.2s ease;
        }

        .drop-zone.drag-over {
            background: rgba(37, 99, 235, 0.1);
            border-color: var(--primary-color);
        }

        /* Loading spinner animation */
        .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .metric-card {
                padding: 1.5rem;
            }

            .card-body {
                padding: 1rem;
            }

            .sponsorship-container {
                padding: 1rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Custom Analytics Styles */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .college-stats {
            max-height: 250px;
            overflow-y: auto;
        }

        .stat-box {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .card {
                background: #1e293b;
                border-color: #334155;
                color: #f1f5f9;
            }
        }
            overflow-y: auto;
        }

        .stat-box {
            transition: transform 0.2s;
        }

        .stat-box:hover {
            transform: translateY(-2px);
        }

        /* Chart containers */
        #userActivityChart, #usageDistributionChart, #userJourneyChart {
            max-width: 100%;
            height: auto;
        }

        /* Real-time indicator */
        .badge.pulse {
            animation: pulse 1.5s infinite;
        }

        /* Enhanced cards */
        .card-header {
            background-color: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.125);
        }

        /* Progress bars */
        .progress {
            height: 10px;
        }

        .progress-bar {
            transition: width 0.6s ease;
        }

        /* Analytics specific styles */
        .analytics-container .card {
            margin-bottom: 1.5rem;
        }

        .analytics-container canvas {
            border-radius: 8px;
        }

        /* Mobile responsiveness for analytics */
        @media (max-width: 768px) {
            .analytics-container .col-md-3 {
                margin-bottom: 1rem;
            }
            
            .stat-box {
                margin-bottom: 1rem;
            }
        }
        
        /* Quick Actions Styles */
        .quick-actions {
            background: var(--light-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .quick-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            margin: 0.25rem;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--dark-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            text-decoration: none;
        }

        .quick-action-btn i {
            font-size: 1rem;
        }

        /* Enhanced Stat Cards */
        .stat-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.products { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.rooms { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.revenue { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        /* Dashboard Cards */
        .dashboard-card {
            border: none;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            box-shadow: var(--shadow-md);
        }

        .dashboard-card .card-header {
            background: var(--light-color);
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: 1.25rem 1.5rem;
        }

        .dashboard-card .card-body {
            padding: 1.5rem;
        }
        .sponsorship-container {
            padding: 20px;
        }
        
        .sponsorship-item {
            transition: all 0.3s ease;
            background-color: #f8f9fa !important;
        }
        
        .sponsorship-item:hover {
            background-color: #e9ecef !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .sponsor-slot {
            font-size: 1.2em;
            font-weight: bold;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .search-result-item {
            transition: all 0.2s ease;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        
        .sponsorship-sequence {
            min-height: 200px;
        }
        
        /* Products Analytics Styles */
        .analytics-container .card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 2rem;
        }
        
        .analytics-container .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }
        
        .analytics-container .stat-box {
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .analytics-container .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .products-analytics-table {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .products-analytics-table th {
            background: #495057;
            color: white;
            border: none;
            padding: 1rem;
            font-weight: 600;
        }
        
        .products-analytics-table td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }
        
        .products-analytics-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        
        .product-image img {
            border: 2px solid #e9ecef;
        }
        
        .progress {
            border-radius: 10px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
        }
        
        #productSearchInput {
            border-radius: 0.5rem 0 0 0.5rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        #productSearchInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        #clearProductSearch {
            border-radius: 0 0.5rem 0.5rem 0;
            border: 2px solid #e9ecef;
            border-left: none;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="mb-0">Loading...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <form id="loginForm" class="login-form">
            <div class="login-logo">
                <h1>
                    <i class="fas fa-graduation-cap"></i>
                    StudX Admin
                </h1>
                <p class="subtitle">Management Dashboard</p>
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="username" placeholder="Enter your username" required>
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">Remember me</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-sign-in-alt me-2"></i>
                Sign In
            </button>
            <div id="errorMessage" class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Invalid username or password
            </div>
        </form>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>
                    <i class="fas fa-graduation-cap"></i>
                    StudX Admin
                </h3>
                <p class="sidebar-subtitle">Management Dashboard</p>
            </div>
            <nav class="nav flex-column">
                <a href="#" class="nav-link active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="nav-link" data-page="products">
                    <i class="fas fa-box"></i> Products
                </a>
                <a href="#" class="nav-link" data-page="users">
                    <i class="fas fa-users"></i> Users
                </a>
                <a href="#" class="nav-link" data-page="analytics">
                    <i class="fas fa-chart-line"></i> Analytics
                </a>
                <a href="#" class="nav-link" data-page="transactions">
                    <i class="fas fa-exchange-alt"></i> Transaction History
                </a>
                <a href="#" class="nav-link" data-page="sponsorship">
                    <i class="fas fa-star"></i> Sponsorship
                </a>
                <a href="#" class="nav-link" data-page="settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
                <a href="#" class="nav-link text-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Mobile Header -->
            <div class="mobile-header d-md-none">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h5 class="mb-0">StudX Admin</h5>
                <div></div> <!-- Spacer -->
            </div>

            <!-- Enhanced Page Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 id="pageTitle" class="h3 mb-0">Dashboard</h1>
                        <p id="pageSubtitle" class="text-muted mb-0">Welcome to your admin dashboard</p>
                    </div>
                    <div class="header-actions">
                        <div class="search-container d-none d-md-block" style="width: 300px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="globalSearch" placeholder="Search anything...">
                        </div>
                        <button class="btn btn-primary ms-2" id="refreshData" title="Refresh Data">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content Container -->
            <div id="content" class="content-area">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
(async function() {
    // SUPABASE CONFIG - UPDATED WITH YOUR ACTUAL DATABASE CREDENTIALS
    const SUPABASE_URL = 'https://vdpmumstdxgftaaxeacx.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkcG11bXN0ZHhnZnRhYXhlYWN4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkwNjA4MiwiZXhwIjoyMDY3NDgyMDgyfQ.tdYV9te2jYq2ARdPiJi6mpkqfvg45YlfgZ2kXnhLVRs'; // Using service role for admin access
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

    function initializeApp() {
        console.log('Initializing app...');
        // Initialize components
        initMobileMenu();
        initThemeToggle();
        attachSidebarHandlers(); // Ensure sidebar handlers are attached
        checkLogin(); // Check login status
    }

    // Check login status
    function checkLogin() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const rememberMe = localStorage.getItem('rememberMe');
        
        if (isLoggedIn === 'true' && rememberMe === 'true') {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadPage('dashboard');
            attachSidebarHandlers();
        } else {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
    }

    // Handle login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;

        // Simple demo login - accept any credentials
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        if (rememberMe) {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('savedUsername', username);
        }
        
        loadPage('dashboard');
        attachSidebarHandlers();
    });

    // Attach sidebar navigation handlers
    function attachSidebarHandlers() {
        console.log('Attaching sidebar handlers...');
        const navLinks = document.querySelectorAll('.nav-link[data-page]');
        console.log('Found nav links:', navLinks.length);
        
        // Method 1: Direct onclick assignment
        navLinks.forEach(link => {
            link.onclick = function(e) {
                e.preventDefault();
                console.log('Nav link clicked:', this.getAttribute('data-page'));
                const page = this.getAttribute('data-page');
                loadPage(page);
            };
        });
        
        // Method 2: Event delegation as fallback
        document.addEventListener('click', function(e) {
            if (e.target.closest('.nav-link[data-page]')) {
                e.preventDefault();
                const link = e.target.closest('.nav-link[data-page]');
                const page = link.getAttribute('data-page');
                console.log('Nav link clicked via delegation:', page);
                loadPage(page);
            }
        });
        
        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.onclick = function(e) {
                e.preventDefault();
                console.log('Logout clicked');
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('rememberMe');
                localStorage.removeItem('savedUsername');
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
            };
        }
    }

    // Function to load page content
    function loadPage(page) {
        console.log('Loading page:', page);
        const contentDiv = document.getElementById('content');
        
        if (!contentDiv) {
            console.error('Content div not found!');
            return;
        }
        
        // Update active link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-page') === page) {
                link.classList.add('active');
            }
        });

        // Update page title
        const pageTitle = document.getElementById('pageTitle');
        const pageSubtitle = document.getElementById('pageSubtitle');
        
        if (pageTitle) {
            pageTitle.textContent = page.charAt(0).toUpperCase() + page.slice(1);
        }
        if (pageSubtitle) {
            pageSubtitle.textContent = `Manage ${page} data and settings`;
        }

        if (page === 'dashboard') {
            contentDiv.innerHTML = `
                <div class="dashboard-container">
                    <h2><i class="fas fa-tachometer-alt"></i> StudX Analytics Dashboard</h2>
                    
                    <!-- Quick Actions Panel -->
                    <div class="quick-actions">
                        <h5 class="mb-3"><i class="fas fa-bolt"></i> Quick Actions</h5>
                        <div class="d-flex flex-wrap">
                            <a href="#" class="quick-action-btn" onclick="loadPage('products')">
                                <i class="fas fa-plus"></i> Add Product
                            </a>
                            <a href="#" class="quick-action-btn" onclick="loadPage('users')">
                                <i class="fas fa-user-plus"></i> Add User
                            </a>
                            <a href="#" class="quick-action-btn" onclick="loadPage('sponsorship')">
                                <i class="fas fa-star"></i> Manage Sponsorship
                            </a>
                            <a href="#" class="quick-action-btn" onclick="showNotification('Export feature coming soon!', 'info')">
                                <i class="fas fa-download"></i> Export Data
                            </a>
                            <a href="#" class="quick-action-btn" onclick="loadPage('analytics')">
                                <i class="fas fa-chart-line"></i> View Analytics
                            </a>
                            <a href="#" class="quick-action-btn" onclick="loadPage('settings')">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                        </div>
                    </div>
                    
                    <!-- Real-time Stats Section -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-1" id="totalUsers">-</h3>
                                        <p class="text-muted mb-0">Total Users</p>
                                        <small class="text-success" id="usersGrowth">
                                            Loading...
                                        </small>
                                    </div>
                                    <div class="stat-icon users">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-1" id="totalProducts">-</h3>
                                        <p class="text-muted mb-0">Products Listed</p>
                                        <small class="text-success" id="productsGrowth">
                                            Loading...
                                        </small>
                                    </div>
                                    <div class="stat-icon products">
                                        <i class="fas fa-shopping-bag"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-1" id="totalRooms">-</h3>
                                        <p class="text-muted mb-0">Rooms Available</p>
                                        <small class="text-info" id="roomsGrowth">
                                            Loading...
                                        </small>
                                    </div>
                                    <div class="stat-icon rooms">
                                        <i class="fas fa-home"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-1" id="totalRevenue">-</h3>
                                        <p class="text-muted mb-0">Total Revenue</p>
                                        <small class="text-success" id="revenueGrowth">
                                            Loading...
                                        </small>
                                    </div>
                                    <div class="stat-icon revenue">
                                        <i class="fas fa-rupee-sign"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="row mb-4">
                        <div class="col-lg-8 mb-3">
                            <div class="card dashboard-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Revenue Trends</h5>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            Last 30 Days
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#">Last 7 Days</a></li>
                                            <li><a class="dropdown-item" href="#">Last 30 Days</a></li>
                                            <li><a class="dropdown-item" href="#">Last 3 Months</a></li>
                                            <li><a class="dropdown-item" href="#">Last Year</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                            <div class="card dashboard-card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Category Distribution</h5>
                                </div>
                                <div class="card-body d-flex align-items-center justify-content-center">
                                    <canvas id="categoryChart" width="200" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Analytics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-dark text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-rupee-sign fa-2x me-3"></i>
                                        <div>
                                            <h5>Total Revenue</h5>
                                            <h3 id="totalRevenue">â‚¹0</h3>
                                            <small id="revenueGrowth">This month</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-purple text-white" style="background-color: #6f42c1 !important;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-chart-line fa-2x me-3"></i>
                                        <div>
                                            <h5>Active Users</h5>
                                            <h3 id="activeUsers">-</h3>
                                            <small id="activeUsersTime">Last 7 days</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4) !important;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-star fa-2x me-3"></i>
                                        <div>
                                            <h5>Top College</h5>
                                            <h4 id="topCollege">-</h4>
                                            <small id="topCollegeCount">0 listings</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #667eea, #764ba2) !important;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-fire fa-2x me-3"></i>
                                        <div>
                                            <h5>Hot Category</h5>
                                            <h4 id="hotCategory">-</h4>
                                            <small id="hotCategoryCount">0 items</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Behavior Analytics -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-users"></i> User Activity Trends</h5>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary active" data-period="7">7D</button>
                                        <button class="btn btn-outline-primary" data-period="30">30D</button>
                                        <button class="btn btn-outline-primary" data-period="90">90D</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="userActivityChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> Platform Usage Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="usageDistributionChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Real-time Monitoring -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-chart-bar"></i> Real-time Analytics</h5>
                                    <span class="badge bg-success pulse" id="liveIndicator">LIVE</span>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center mb-3">
                                        <div class="col-md-4">
                                            <h3 id="onlineUsers" class="text-success">0</h3>
                                            <small class="text-muted">Online Now</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h3 id="todayListings" class="text-primary">0</h3>
                                            <small class="text-muted">Today's Listings</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h3 id="todaySignups" class="text-warning">0</h3>
                                            <small class="text-muted">New Signups</small>
                                        </div>
                                    </div>
                                    <div id="recentActivity" class="recent-activity">
                                        <h6>Recent Activity:</h6>
                                        <div id="activityFeed" class="activity-feed">
                                            <div class="activity-item">
                                                <i class="fas fa-spinner fa-spin"></i> Loading recent activity...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-map-marker-alt"></i> Geographic Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div id="collegeDistribution" class="college-stats">
                                        <div class="d-flex justify-content-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-cog"></i> Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="loadPage('products')">
                                            <i class="fas fa-box"></i> Manage Products
                                        </button>
                                        <button class="btn btn-outline-success" onclick="loadPage('users')">
                                            <i class="fas fa-users"></i> Manage Users
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="loadPage('analytics')">
                                            <i class="fas fa-chart-line"></i> Advanced Analytics
                                        </button>
                                        <button class="btn btn-outline-info" onclick="window.open('https://studxchange.vercel.app', '_blank')">
                                            <i class="fas fa-external-link-alt"></i> Open StudXchange Site
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="exportData()">
                                            <i class="fas fa-download"></i> Export Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-bell"></i> System Health</h5>
                                </div>
                                <div class="card-body">
                                    <div id="systemHealth">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Database Connection</span>
                                            <span class="badge bg-success" id="dbStatus">Connected</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Storage Usage</span>
                                            <span class="badge bg-warning" id="storageStatus">Loading...</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>API Response Time</span>
                                            <span class="badge bg-success" id="apiStatus">Fast</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Active Sessions</span>
                                            <span class="badge bg-info" id="sessionStatus">-</span>
                                        </div>
                                        <div class="progress mt-3">
                                            <div class="progress-bar bg-success" role="progressbar" id="healthProgress" style="width: 85%">85% Healthy</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderDashboard();
        } else if (page === 'products') {
            contentDiv.innerHTML = `
                <div class="products-header mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h2><i class="fas fa-box"></i> Products Management</h2>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <select id="sortSelect" class="form-select" style="width: auto;">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="name">Name A-Z</option>
                                    <option value="type">Type</option>
                                </select>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-danger" id="bulkDeleteBtn" disabled>
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                    <button class="btn btn-outline-secondary" id="selectAllBtn">
                                        <i class="fas fa-check-square"></i> Select All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class='mb-3'>
                    <input type='text' id='productSearch' class='form-control' placeholder='Search products, rooms, notes...'>
                </div>
                <div id='productCards' class='row g-3'></div>
            `;
            renderProductsPage();
        } else if (page === 'users') {
            contentDiv.innerHTML = `<h2><i class="fas fa-users"></i> Users Management</h2><div id='usersTable'></div>`;
            renderUsersPage();
        } else if (page === 'analytics') {
            contentDiv.innerHTML = `
                <div class="analytics-container">
                    <h2><i class="fas fa-chart-line"></i> Advanced Analytics</h2>
                    
                    <!-- Marketplace Analytics Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar"></i> Marketplace Performance Analytics</h5>
                                    <!-- Tabs for different content types -->
                                    <ul class="nav nav-tabs card-header-tabs mt-3" id="analyticsTabsList" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-analytics" type="button" role="tab">
                                                <i class="fas fa-box"></i> Products <span id="productsTabCount" class="badge bg-primary ms-1">0</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-analytics" type="button" role="tab">
                                                <i class="fas fa-sticky-note"></i> Notes <span id="notesTabCount" class="badge bg-warning ms-1">0</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms-analytics" type="button" role="tab">
                                                <i class="fas fa-home"></i> Rooms <span id="roomsTabCount" class="badge bg-info ms-1">0</span>
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="analyticsTabsContent">
                                        
                                        <!-- Products Analytics Tab -->
                                        <div class="tab-pane fade show active" id="products-analytics" role="tabpanel">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="fas fa-box text-primary"></i> Products Performance</h6>
                                                <div class="d-flex align-items-center">
                                                    <div class="input-group" style="width: 300px;">
                                                        <input type="text" id="productSearchInput" class="form-control form-control-sm" placeholder="Search products...">
                                                        <button class="btn btn-outline-secondary btn-sm" type="button" id="clearProductSearch">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <button class="btn btn-primary btn-sm ms-2" onclick="refreshProductsAnalytics()">
                                                        <i class="fas fa-sync-alt"></i> Refresh
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="totalProducts" class="text-primary mb-1">-</h4>
                                                        <small class="text-muted">Total Products</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="totalViews" class="text-success mb-1">-</h4>
                                                        <small class="text-muted">Total Views</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="avgViewsPerProduct" class="text-info mb-1">-</h4>
                                                        <small class="text-muted">Avg Views/Product</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="topPerformingCategory" class="text-warning mb-1">-</h4>
                                                        <small class="text-muted">Top Category</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Products Table -->
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table table-hover table-striped">
                                                    <thead class="table-dark sticky-top">
                                                        <tr>
                                                            <th style="width: 40%;">Product</th>
                                                            <th style="width: 15%;">Category</th>
                                                            <th style="width: 10%;">Price</th>
                                                            <th style="width: 10%;">Views</th>
                                                            <th style="width: 15%;">Performance</th>
                                                            <th style="width: 10%;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="productsAnalyticsTable">
                                                        <tr>
                                                            <td colspan="6" class="text-center py-4">
                                                                <div class="spinner-border text-primary" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                                <p class="mt-2 text-muted">Loading products data...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- Notes Analytics Tab -->
                                        <div class="tab-pane fade" id="notes-analytics" role="tabpanel">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="fas fa-sticky-note text-warning"></i> Notes Performance</h6>
                                                <div class="d-flex align-items-center">
                                                    <div class="input-group" style="width: 300px;">
                                                        <input type="text" id="notesSearchInput" class="form-control form-control-sm" placeholder="Search notes...">
                                                        <button class="btn btn-outline-secondary btn-sm" type="button" id="clearNotesSearch">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <button class="btn btn-warning btn-sm ms-2" onclick="refreshNotesAnalytics()">
                                                        <i class="fas fa-sync-alt"></i> Refresh
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="totalNotes" class="text-warning mb-1">-</h4>
                                                        <small class="text-muted">Total Notes</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="totalNotesViews" class="text-success mb-1">-</h4>
                                                        <small class="text-muted">Total Views</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="avgViewsPerNote" class="text-info mb-1">-</h4>
                                                        <small class="text-muted">Avg Views/Note</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="topNotesSubject" class="text-primary mb-1">-</h4>
                                                        <small class="text-muted">Top Subject</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Notes Table -->
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table table-hover table-striped">
                                                    <thead class="table-dark sticky-top">
                                                        <tr>
                                                            <th style="width: 35%;">Note Title</th>
                                                            <th style="width: 15%;">Subject</th>
                                                            <th style="width: 10%;">Year</th>
                                                            <th style="width: 10%;">Price</th>
                                                            <th style="width: 10%;">Views</th>
                                                            <th style="width: 10%;">Performance</th>
                                                            <th style="width: 10%;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="notesAnalyticsTable">
                                                        <tr>
                                                            <td colspan="7" class="text-center py-4">
                                                                <div class="spinner-border text-warning" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                                <p class="mt-2 text-muted">Loading notes data...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- Rooms Analytics Tab -->
                                        <div class="tab-pane fade" id="rooms-analytics" role="tabpanel">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="fas fa-home text-info"></i> Rooms Performance</h6>
                                                <div class="d-flex align-items-center">
                                                    <div class="input-group" style="width: 300px;">
                                                        <input type="text" id="roomsSearchInput" class="form-control form-control-sm" placeholder="Search rooms...">
                                                        <button class="btn btn-outline-secondary btn-sm" type="button" id="clearRoomsSearch">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <button class="btn btn-info btn-sm ms-2" onclick="refreshRoomsAnalytics()">
                                                        <i class="fas fa-sync-alt"></i> Refresh
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="analyticsRooms" class="text-info mb-1">-</h4>
                                                        <small class="text-muted">Total Rooms</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="totalRoomsViews" class="text-success mb-1">-</h4>
                                                        <small class="text-muted">Total Views</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="avgViewsPerRoom" class="text-warning mb-1">-</h4>
                                                        <small class="text-muted">Avg Views/Room</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="stat-box text-center p-3 border rounded bg-light">
                                                        <h4 id="topRoomType" class="text-primary mb-1">-</h4>
                                                        <small class="text-muted">Top Room Type</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Rooms Table -->
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table table-hover table-striped">
                                                    <thead class="table-dark sticky-top">
                                                        <tr>
                                                            <th style="width: 35%;">Room/Hostel</th>
                                                            <th style="width: 15%;">Type</th>
                                                            <th style="width: 10%;">Location</th>
                                                            <th style="width: 10%;">Rent</th>
                                                            <th style="width: 10%;">Views</th>
                                                            <th style="width: 10%;">Performance</th>
                                                            <th style="width: 10%;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="roomsAnalyticsTable">
                                                        <tr>
                                                            <td colspan="7" class="text-center py-4">
                                                                <div class="spinner-border text-info" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                                <p class="mt-2 text-muted">Loading rooms data...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Behavior Analytics -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar"></i> User Behavior Analytics</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="stat-box text-center p-3 border rounded">
                                                <h4 id="avgSessionTime" class="text-primary">-</h4>
                                                <small class="text-muted">Avg Session Time</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-box text-center p-3 border rounded">
                                                <h4 id="bounceRate" class="text-warning">-</h4>
                                                <small class="text-muted">Bounce Rate</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-box text-center p-3 border rounded">
                                                <h4 id="conversionRate" class="text-success">-</h4>
                                                <small class="text-muted">Conversion Rate</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-box text-center p-3 border rounded">
                                                <h4 id="retentionRate" class="text-info">-</h4>
                                                <small class="text-muted">7-Day Retention</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="advancedCharts">
                                        <canvas id="userJourneyChart" width="800" height="400"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderAdvancedAnalytics();
        } else if (page === 'transactions') {
            contentDiv.innerHTML = `
                <div class="transactions-container">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-exchange-alt"></i> Transaction History</h2>
                        <div class="d-flex gap-2">
                            <select id="transactionFilter" class="form-select" style="width: auto;">
                                <option value="all">All Transactions</option>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                            <input type="date" id="transactionDate" class="form-control" style="width: auto;">
                            <button class="btn btn-primary" onclick="exportTransactions()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>

                    <!-- Transaction Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-check-circle fa-2x me-3"></i>
                                        <div>
                                            <h5>Completed</h5>
                                            <h3 id="completedTransactions">-</h3>
                                            <small>Total transactions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clock fa-2x me-3"></i>
                                        <div>
                                            <h5>Pending</h5>
                                            <h3 id="pendingTransactions">-</h3>
                                            <small>Awaiting completion</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-rupee-sign fa-2x me-3"></i>
                                        <div>
                                            <h5>Total Volume</h5>
                                            <h3 id="totalVolume">â‚¹-</h3>
                                            <small>All transactions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-percentage fa-2x me-3"></i>
                                        <div>
                                            <h5>Platform Revenue</h5>
                                            <h3 id="platformRevenue">â‚¹-</h3>
                                            <small>Total earnings</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Recent Transactions</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Item</th>
                                            <th>Buyer</th>
                                            <th>Phone</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize analytics with tab handling
            setTimeout(async () => {
                console.log('=== ANALYTICS INITIALIZATION DEBUG ===');
                console.log('Initializing analytics dashboard...');
                
                try {
                    // Test database connectivity first
                    console.log('Testing database connectivity...');
                    console.log('Supabase instance:', !!supabase);
                    console.log('Supabase URL:', supabase.supabaseUrl);
                    
                    // Test with a simple query to see what works
                    console.log('Testing basic database access...');
                    const { data: testData, error: testError } = await supabase
                        .from('users')
                        .select('count')
                        .limit(1);
                    
                    if (testError) {
                        console.error('Basic database test failed:', testError);
                        console.log('Testing products table access...');
                        
                        const { data: productsTest, error: productsError } = await supabase
                            .from('products')
                            .select('count')
                            .limit(1);
                        
                        if (productsError) {
                            console.error('Products table test failed:', productsError);
                            throw new Error(`Database connection failed: ${testError.message}`);
                        } else {
                            console.log('Products table accessible');
                        }
                    } else {
                        console.log('Basic database connection successful');
                    }
                    
                    // Test table existence
                    console.log('Checking table existence...');
                    const { data: allTables, error: tablesError } = await supabase
                        .from('information_schema.tables')
                        .select('table_name')
                        .eq('table_schema', 'public');
                    
                    if (allTables) {
                        const tableNames = allTables.map(t => t.table_name);
                        console.log('Available tables:', tableNames);
                        console.log('Notes table exists:', tableNames.includes('notes'));
                        console.log('Rooms table exists:', tableNames.includes('rooms'));
                        console.log('Products table exists:', tableNames.includes('products'));
                    } else {
                        console.log('Could not check table existence:', tablesError);
                    }
                    
                    console.log('Database connectivity test complete');
                    
                    // Load products analytics by default
                    console.log('Loading default products analytics...');
                    await renderProductsAnalytics();
                    
                    // Setup tab switching functionality
                    const productTab = document.getElementById('products-tab');
                    const notesTab = document.getElementById('notes-tab');
                    const roomsTab = document.getElementById('rooms-tab');
                    
                    if (productTab) {
                        productTab.addEventListener('shown.bs.tab', async () => {
                            console.log('Switching to products tab');
                            await renderProductsAnalytics();
                        });
                    }
                    
                    if (notesTab) {
                        notesTab.addEventListener('shown.bs.tab', async () => {
                            console.log('Switching to notes tab');
                            await renderNotesAnalytics();
                        });
                    }
                    
                    if (roomsTab) {
                        roomsTab.addEventListener('shown.bs.tab', async () => {
                            console.log('Switching to rooms tab');
                            await renderRoomsAnalytics();
                        });
                    }
                    
                    console.log('Analytics dashboard initialized successfully');
                    console.log('=== INITIALIZATION COMPLETE ===');
                    
                } catch (error) {
                    console.error('=== INITIALIZATION FAILED ===');
                    console.error('Failed to initialize analytics dashboard:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        supabaseConnected: !!supabase
                    });
                    
                    // Show error in the main content area
                    const contentDiv = document.querySelector('.analytics-container');
                    if (contentDiv) {
                        contentDiv.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-exclamation-triangle text-danger fs-1"></i>
                                <h3 class="mt-3 text-danger">Analytics Initialization Failed</h3>
                                <p class="text-muted">Error: ${error.message}</p>
                                <p class="small text-muted">Check browser console for detailed error information</p>
                                <button class="btn btn-primary" onclick="location.reload()">Reload Page</button>
                            </div>
                        `;
                    }
                }
            }, 100);
            
            loadTransactionHistory();
        } else if (page === 'sponsorship') {
            contentDiv.innerHTML = `
                <div class="sponsorship-management-container">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-star text-warning"></i> Sponsorship Management</h2>
                            <p class="text-muted mb-0">Manage featured items with sequence control</p>
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="openAddSponsorModal()">
                            <i class="fas fa-plus me-2"></i>Add Sponsor Products
                        </button>
                    </div>

                    <!-- Current Sponsored Items -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">
                                        <i class="fas fa-list-ol me-2"></i>Current Sponsored Items
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshCurrentSponsors()">
                                            <i class="fas fa-refresh"></i>
                                        </button>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="currentSponsoredItems">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-2">Loading current sponsored items...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Sponsorship Modal -->
                <div class="modal fade" id="newSponsorshipModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-star me-2"></i>Add New Sponsored Items
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Search and Filter -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" id="itemSearchInput" class="form-control" 
                                                   placeholder="Search by name, title, or description..." 
                                                   oninput="filterAvailableItems()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="itemTypeFilter" class="form-select" onchange="filterAvailableItems()">
                                            <option value="">All Types</option>
                                            <option value="product">Products</option>
                                            <option value="note">Notes</option>
                                            <option value="room">Rooms</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-secondary" onclick="clearAllNewSelections()">
                                            <i class="fas fa-times me-1"></i>Clear All
                                        </button>
                                    </div>
                                </div>

                                <!-- Available Items Grid -->
                                <div id="availableItemsGrid" class="row g-3" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                                    <div class="col-12 text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2">Loading available items...</p>
                                    </div>
                                </div>

                                <!-- Selected Items Preview -->
                                <div id="selectedItemsPreview" class="mt-3" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-check-circle me-2"></i>Selected Items for Sponsorship:</h6>
                                        <div id="selectedItemsContainer" class="row g-2"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                                <button type="button" id="addSelectedSponsors" class="btn btn-success btn-lg" onclick="processSelectedSponsors()" disabled>
                                    <i class="fas fa-star me-2"></i>Select Items First
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sequence Setting Modal -->
                <div class="modal fade" id="sequenceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-sort-numeric-up me-2"></i>Set Sequence Order
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="sequenceItemsContainer">
                                    <!-- Items with sequence inputs will be populated here -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" onclick="saveSponsorsWithSequence()">
                                    <i class="fas fa-save me-2"></i>Save Sponsors
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadCurrentSponsoredItems();
        } else if (page === 'settings') {
        } else if (page === 'settings') {
            contentDiv.innerHTML = `
                <div class='container py-4'>
                    <h2><i class="fas fa-cog"></i> Admin Settings</h2>
                    <div class='alert alert-info'>
                        <i class="fas fa-info-circle"></i> Settings functionality coming soon. This is a demo admin panel.
                    </div>
                </div>
            `;
        } else {
            contentDiv.innerHTML = `<div class="alert alert-danger">Unknown page: ${page}</div>`;
        }
    }

    // Dashboard: Load statistics with enhanced analytics
    async function renderDashboard() {
        try {
            const startTime = Date.now();
            
            console.log('ðŸ” Starting dashboard data fetch...');
            
            // Get current data with individual error handling
            const productsResult = await supabase.from('products').select('*', { count: 'exact' });
            console.log('ðŸ“¦ Products result:', productsResult);
            
            const notesResult = await supabase.from('notes').select('*', { count: 'exact' });
            console.log('ðŸ“ Notes result:', notesResult);
            
            const roomsResult = await supabase.from('rooms').select('*', { count: 'exact' });
            console.log('ðŸ  Rooms result:', roomsResult);
            
            const usersResult = await supabase.from('users').select('*', { count: 'exact' });
            console.log('ðŸ‘¥ Users result:', usersResult);
            
            const transactionsResult = await supabase.from('transactions').select('*').throwOnError(false);
            console.log('ðŸ’° Transactions result:', transactionsResult);
            
            const sponsorshipResult = await supabase.from('sponsorship_sequences').select('*', { count: 'exact' }).throwOnError(false);
            console.log('ðŸŒŸ Sponsorship result:', sponsorshipResult);
            
            // Extract data safely
            const products = productsResult.data || [];
            const productsCount = productsResult.count || 0;
            const notes = notesResult.data || [];
            const notesCount = notesResult.count || 0;
            const rooms = roomsResult.data || [];
            const roomsCount = roomsResult.count || 0;
            const users = usersResult.data || [];
            const usersCount = usersResult.count || 0;
            const transactions = transactionsResult.data || [];
            const sponsorships = sponsorshipResult.data || [];
            const sponsorshipsCount = sponsorshipResult.count || 0;
            
            console.log(`ðŸ“Š Final counts - Products: ${productsCount}, Notes: ${notesCount}, Rooms: ${roomsCount}, Users: ${usersCount}, Sponsorships: ${sponsorshipsCount}`);

            // Calculate API response time
            const responseTime = Date.now() - startTime;
            const apiStatusEl = document.getElementById('apiStatus');
            if (apiStatusEl) {
                apiStatusEl.textContent = responseTime < 500 ? 'Fast' : responseTime < 1000 ? 'Moderate' : 'Slow';
                apiStatusEl.className = `badge ${responseTime < 500 ? 'bg-success' : responseTime < 1000 ? 'bg-warning' : 'bg-danger'}`;
            }

            // Update basic counts with null checks
            const productsCountEl = document.getElementById('productsCount');
            const notesCountEl = document.getElementById('notesCount');
            const roomsCountEl = document.getElementById('roomsCount');
            const usersCountEl = document.getElementById('usersCount');
            
            if (productsCountEl) productsCountEl.textContent = productsCount || 0;
            if (notesCountEl) notesCountEl.textContent = notesCount || 0;
            if (roomsCountEl) roomsCountEl.textContent = roomsCount || 0;
            if (usersCountEl) usersCountEl.textContent = usersCount || 0;

            // Calculate growth metrics (comparing with last week)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const recentProducts = products.filter(p => new Date(p.created_at) > oneWeekAgo).length;
            const recentNotes = notes.filter(n => new Date(n.created_at) > oneWeekAgo).length;
            const recentRooms = rooms.filter(r => new Date(r.created_at) > oneWeekAgo).length;
            const recentUsers = users.filter(u => new Date(u.created_at) > oneWeekAgo).length;

            // Update old dashboard elements with null checks
            const productsGrowthEl = document.getElementById('productsGrowth');
            const notesGrowthEl = document.getElementById('notesGrowth');
            const roomsGrowthEl = document.getElementById('roomsGrowth');
            const usersGrowthEl = document.getElementById('usersGrowth');
            
            if (productsGrowthEl) productsGrowthEl.textContent = `+${recentProducts} this week`;
            if (notesGrowthEl) notesGrowthEl.textContent = `+${recentNotes} this week`;
            if (roomsGrowthEl) roomsGrowthEl.textContent = `+${recentRooms} this week`;
            if (usersGrowthEl) usersGrowthEl.textContent = `+${recentUsers} this week`;

            // Update basic counts in new stat cards with null checks
            const totalUsersEl = document.getElementById('totalUsers');
            const totalProductsEl = document.getElementById('totalProducts');
            const totalRoomsEl = document.getElementById('totalRooms');
            const totalRevenueEl = document.getElementById('totalRevenue');
            
            if (totalUsersEl) totalUsersEl.textContent = usersCount || 0;
            if (totalProductsEl) totalProductsEl.textContent = productsCount || 0;
            if (totalRoomsEl) totalRoomsEl.textContent = roomsCount || 0;

            // Calculate revenue (from transactions)
            const totalRevenue = transactions.reduce((sum, t) => sum + (parseFloat(t.platform_fee) || 0), 0);
            if (totalRevenueEl) totalRevenueEl.textContent = totalRevenue > 0 ? `â‚¹${totalRevenue.toLocaleString()}` : 'â‚¹0';

            // Calculate recent revenue for growth indicator
            const recentRevenue = transactions
                .filter(t => new Date(t.created_at) > oneWeekAgo)
                .reduce((sum, t) => sum + (parseFloat(t.platform_fee) || 0), 0);

            // Update growth indicators for new stat cards with null checks
            const usersGrowthNewEl = document.getElementById('usersGrowth');
            if (usersGrowthNewEl) {
                usersGrowthNewEl.innerHTML = recentUsers > 0 ? 
                    `<i class="fas fa-arrow-up"></i> +${recentUsers} this week` : 
                    '<i class="fas fa-minus"></i> No new users';
            }
            
            const productsGrowthNewEl = document.getElementById('productsGrowth');
            if (productsGrowthNewEl) {
                productsGrowthNewEl.innerHTML = recentProducts > 0 ? 
                    `<i class="fas fa-arrow-up"></i> +${recentProducts} this week` : 
                    '<i class="fas fa-minus"></i> No new products';
            }
            
            const roomsGrowthNewEl = document.getElementById('roomsGrowth');
            if (roomsGrowthNewEl) {
                roomsGrowthNewEl.innerHTML = recentRooms > 0 ? 
                    `<i class="fas fa-arrow-up"></i> +${recentRooms} this week` : 
                    '<i class="fas fa-minus"></i> No new rooms';
            }
            
            const revenueGrowthEl = document.getElementById('revenueGrowth');
            if (revenueGrowthEl) {
                revenueGrowthEl.innerHTML = recentRevenue > 0 ? 
                    `<i class="fas fa-arrow-up"></i> +â‚¹${recentRevenue.toLocaleString()} this week` : 
                    '<i class="fas fa-minus"></i> No revenue';
            }

            // Update old dashboard elements (for compatibility)
            if (document.getElementById('productsCount')) {
                document.getElementById('productsCount').textContent = productsCount || 0;
                document.getElementById('notesCount').textContent = notesCount || 0;
                document.getElementById('roomsCount').textContent = roomsCount || 0;
                document.getElementById('usersCount').textContent = usersCount || 0;
                
                // Update old growth indicators too
                if (document.getElementById('productsGrowth')) {
                    document.getElementById('productsGrowth').textContent = `+${recentProducts} this week`;
                    document.getElementById('notesGrowth').textContent = `+${recentNotes} this week`;
                    document.getElementById('roomsGrowth').textContent = `+${recentRooms} this week`;
                    document.getElementById('usersGrowth').textContent = `+${recentUsers} this week`;
                }
            }

            // Calculate active users (users with recent activity)
            const activeUsers = users.filter(u => {
                const lastActive = new Date(u.updated_at || u.created_at);
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                return lastActive > sevenDaysAgo;
            }).length;
            if (document.getElementById('activeUsers')) {
                document.getElementById('activeUsers').textContent = activeUsers;
            }

            // Find top college
            const collegeStats = {};
            [...products, ...notes, ...rooms].forEach(item => {
                if (item.college) {
                    collegeStats[item.college] = (collegeStats[item.college] || 0) + 1;
                }
            });
            const topCollege = Object.entries(collegeStats).sort((a, b) => b[1] - a[1])[0];
            if (topCollege && document.getElementById('topCollege')) {
                document.getElementById('topCollege').textContent = topCollege[0];
                document.getElementById('topCollegeCount').textContent = `${topCollege[1]} listings`;
            }

            // Find hot category
            const categoryStats = {};
            [...products, ...notes, ...rooms].forEach(item => {
                if (item.category) {
                    categoryStats[item.category] = (categoryStats[item.category] || 0) + 1;
                }
            });
            const hotCategory = Object.entries(categoryStats).sort((a, b) => b[1] - a[1])[0];
            if (hotCategory && document.getElementById('hotCategory')) {
                document.getElementById('hotCategory').textContent = hotCategory[0];
                document.getElementById('hotCategoryCount').textContent = `${hotCategory[1]} items`;
            }

            // Update real-time stats
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayListings = [...products, ...notes, ...rooms].filter(item => 
                new Date(item.created_at) >= today
            ).length;
            
            const todaySignups = users.filter(user => 
                new Date(user.created_at) >= today
            ).length;

            // Update dashboard stats with null checks
            const todayListingsEl = document.getElementById('todayListings');
            const todaySignupsEl = document.getElementById('todaySignups');
            const onlineUsersEl = document.getElementById('onlineUsers');
            
            if (todayListingsEl) todayListingsEl.textContent = todayListings;
            if (todaySignupsEl) todaySignupsEl.textContent = todaySignups;
            if (onlineUsersEl) onlineUsersEl.textContent = Math.floor(Math.random() * 50) + 10; // Simulated

            // Update activity feed
            const recentActivity = [...products, ...notes, ...rooms, ...users]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            const activityHTML = recentActivity.map(item => {
                const type = item.title ? (item.academic_year ? 'note' : item.room_type ? 'room' : 'product') : 'user';
                const icon = type === 'note' ? 'fas fa-sticky-note text-success' : 
                           type === 'room' ? 'fas fa-home text-warning' : 
                           type === 'product' ? 'fas fa-box text-primary' : 'fas fa-user text-info';
                const action = type === 'user' ? 'joined' : 'posted';
                const timeAgo = getRelativeTime(item.created_at);
                
                return `
                    <div class="activity-item d-flex align-items-center mb-2">
                        <i class="${icon} me-2"></i>
                        <small>
                            <strong>${item.name || item.title || 'Someone'}</strong> ${action} ${type === 'user' ? '' : 'a ' + type}
                            <span class="text-muted">${timeAgo}</span>
                        </small>
                    </div>
                `;
            }).join('');

            document.getElementById('activityFeed').innerHTML = activityHTML || '<div class="activity-item"><i class="fas fa-info-circle text-muted"></i> No recent activity</div>';

            // Update college distribution
            const collegeHTML = Object.entries(collegeStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([college, count]) => {
                    const percentage = Math.round((count / (productsCount + notesCount + roomsCount)) * 100);
                    return `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small>${college}</small>
                            <span class="badge bg-primary">${count} (${percentage}%)</span>
                        </div>
                    `;
                }).join('');

            document.getElementById('collegeDistribution').innerHTML = collegeHTML || '<div class="text-muted text-center">No college data</div>';

            // Update storage status
            const estimatedStorage = Math.round((productsCount + notesCount + roomsCount + usersCount) * 0.001); // Rough estimate
            document.getElementById('storageStatus').textContent = `${estimatedStorage}MB used`;
            document.getElementById('storageStatus').className = `badge ${estimatedStorage < 400 ? 'bg-success' : estimatedStorage < 450 ? 'bg-warning' : 'bg-danger'}`;

            // Update session status
            document.getElementById('sessionStatus').textContent = Math.floor(Math.random() * 20) + 5; // Simulated

            // Live indicator animation
            setInterval(() => {
                const indicator = document.getElementById('liveIndicator');
                if (indicator) {
                    indicator.style.opacity = indicator.style.opacity === '0.5' ? '1' : '0.5';
                }
            }, 1000);

        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('dbStatus').textContent = 'Error';
            document.getElementById('dbStatus').className = 'badge bg-danger';
        }
        
        // Initialize charts after data is loaded
        setTimeout(initializeCharts, 100);
    }

    // Chart initialization function
    async function initializeCharts() {
        try {
            // Destroy existing charts to prevent reuse errors
            const canvasIds = ['revenueChart', 'categoryChart', 'userActivityChart', 'usageDistributionChart'];
            canvasIds.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const existingChart = Chart.getChart(canvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }
                }
            });

            // Fetch real data for charts
            const [
                { data: products = [] },
                { data: notes = [] },
                { data: rooms = [] },
                { data: transactions = [] }
            ] = await Promise.all([
                supabase.from('products').select('*'),
                supabase.from('notes').select('*'),
                supabase.from('rooms').select('*'),
                supabase.from('transactions').select('*').throwOnError(false)
            ]);

            // Calculate real revenue data for last 6 months
            const monthlyRevenue = calculateMonthlyRevenue(transactions);
            const categoryData = calculateCategoryDistribution([...products, ...notes, ...rooms]);
            const weeklyActivity = calculateWeeklyActivity([...products, ...notes, ...rooms]);

            // Revenue Chart with real data
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyRevenue.labels,
                        datasets: [{
                            label: 'Revenue (â‚¹)',
                            data: monthlyRevenue.data,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'â‚¹' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Category Distribution Chart with real data
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryData.labels,
                        datasets: [{
                            data: categoryData.data,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            // User Activity Chart with real data
            const userActivityCtx = document.getElementById('userActivityChart');
            if (userActivityCtx) {
                new Chart(userActivityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'New Listings',
                            data: weeklyActivity,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Usage Distribution Chart with real data
            const usageCtx = document.getElementById('usageDistributionChart');
            if (usageCtx) {
                const usageData = [products.length, notes.length, rooms.length];
                new Chart(usageCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Products', 'Notes', 'Rooms'],
                        datasets: [{
                            data: usageData,
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error initializing charts:', error);
            // Fallback to empty charts if data fetch fails
            initializeEmptyCharts();
        }
    }

    // Helper functions for real data calculations
    function calculateMonthlyRevenue(transactions) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        const now = new Date();
        const labels = [];
        const data = [];
        
        for (let i = 5; i >= 0; i--) {
            const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(months[month.getMonth()]);
            
            const monthRevenue = transactions
                .filter(t => {
                    const tDate = new Date(t.created_at);
                    return tDate.getMonth() === month.getMonth() && 
                           tDate.getFullYear() === month.getFullYear();
                })
                .reduce((sum, t) => sum + (parseFloat(t.platform_fee) || 0), 0);
            
            data.push(monthRevenue);
        }
        
        return { labels, data };
    }

    function calculateCategoryDistribution(items) {
        const categories = {};
        items.forEach(item => {
            if (item.category) {
                categories[item.category] = (categories[item.category] || 0) + 1;
            }
        });
        
        const sorted = Object.entries(categories)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10); // Top 10 categories
        
        return {
            labels: sorted.map(([cat]) => cat),
            data: sorted.map(([, count]) => count)
        };
    }

    function calculateWeeklyActivity(items) {
        const weekDays = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
        const activity = new Array(7).fill(0);
        
        items.forEach(item => {
            const day = new Date(item.created_at).getDay();
            const index = weekDays.indexOf(day);
            if (index !== -1) activity[index]++;
        });
        
        return activity;
    }

    function initializeEmptyCharts() {
        // Initialize charts with no data message
        ['revenueChart', 'categoryChart', 'userActivityChart', 'usageDistributionChart'].forEach(chartId => {
            const ctx = document.getElementById(chartId);
            if (ctx) {
                const parentDiv = ctx.parentElement;
                parentDiv.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-chart-line fa-2x mb-2"></i><br>No data available</div>';
            }
        });
    }

    // Advanced Analytics Function
    async function renderAdvancedAnalytics() {
        try {
            // Fetch data for advanced analytics
            const [
                { data: users = [] },
                { data: products = [] },
                { data: notes = [] },
                { data: rooms = [] },
                { data: transactions = [] }
            ] = await Promise.all([
                supabase.from('users').select('*'),
                supabase.from('products').select('*'),
                supabase.from('notes').select('*'),
                supabase.from('rooms').select('*'),
                supabase.from('transactions').select('*').throwOnError(false)
            ]);

            // Calculate metrics
            const totalUsers = users.length;
            const totalItems = products.length + notes.length + rooms.length;
            const totalTransactions = transactions.length;

            // Simulated advanced metrics (in real app, these would come from tracking)
            document.getElementById('avgSessionTime').textContent = '4m 32s';
            document.getElementById('bounceRate').textContent = '23%';
            document.getElementById('conversionRate').textContent = totalTransactions > 0 ? `${Math.round((totalTransactions / totalUsers) * 100)}%` : '0%';
            document.getElementById('retentionRate').textContent = '78%';

            // Initialize products analytics
            await renderProductsAnalytics(products);

        } catch (error) {
            console.error('Error loading advanced analytics:', error);
        }
    }

    // Products Analytics Functions
    let allProductsData = [];
    let filteredProductsData = [];

    // Analytics View Tracking System with localStorage fallback
    async function trackView(itemType, itemId, itemTitle) {
        try {
            // Try database approach first
            await trackViewInDatabase(itemType, itemId, itemTitle);
        } catch (error) {
            console.log('Database tracking failed, using localStorage:', error);
            // Fallback to localStorage
            trackViewInLocalStorage(itemType, itemId, itemTitle);
        }
    }

    async function trackViewInDatabase(itemType, itemId, itemTitle) {
        try {
            // Insert or update view count using the correct column names
            const { data: existing, error: selectError } = await supabase
                .from('analytics_views')
                .select('*')
                .eq('content_type', itemType)
                .eq('content_id', itemId)
                .single();

            if (selectError && selectError.code !== 'PGRST116') { // PGRST116 = no rows found
                console.log('Error selecting existing view:', selectError);
                throw selectError;
            }

            if (existing) {
                // Update existing record
                const { error: updateError } = await supabase
                    .from('analytics_views')
                    .update({ 
                        views: existing.views + 1,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existing.id);

                if (updateError) {
                    console.log('Error updating view:', updateError);
                    throw updateError;
                }
                console.log(`View updated for ${itemType}:${itemId}`);
            } else {
                // Create new record
                const { error: insertError } = await supabase
                    .from('analytics_views')
                    .insert({
                        content_type: itemType,
                        content_id: itemId,
                        views: 1,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (insertError) {
                    console.log('Error inserting view:', insertError);
                    throw insertError;
                }
                console.log(`New view record created for ${itemType}:${itemId}`);
            }
        } catch (error) {
            console.error('Database view tracking failed:', error);
            throw error;
        }
    }

    function trackViewInLocalStorage(itemType, itemId, itemTitle) {
        const key = `analytics_views_${itemType}_${itemId}`;
        const existing = localStorage.getItem(key);
        const currentViews = existing ? parseInt(existing) : 0;
        localStorage.setItem(key, (currentViews + 1).toString());
    }

    async function ensureAnalyticsTable() {
        try {
            // Try to create the analytics_views table using raw SQL
            const { error } = await supabase.rpc('exec_raw_sql', { 
                sql: `
                    CREATE TABLE IF NOT EXISTS analytics_views (
                        id SERIAL PRIMARY KEY,
                        item_type VARCHAR(50) NOT NULL,
                        item_id VARCHAR(255) NOT NULL,
                        item_title TEXT,
                        view_count INTEGER DEFAULT 1,
                        last_viewed TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        UNIQUE(item_type, item_id)
                    );
                `
            });
            
            if (error) {
                console.log('Table creation via RPC failed, trying simple insert test...');
                // Test if table exists by trying to insert a test record
                const { error: testError } = await supabase
                    .from('analytics_views')
                    .select('count')
                    .limit(1);
                    
                if (testError) {
                    throw new Error('Analytics table not available');
                }
            }
        } catch (error) {
            console.log('Database analytics table setup failed:', error);
            throw error;
        }
    }

    async function getItemViews(itemType, itemId) {
        try {
            // Try database first with correct column names
            const { data, error } = await supabase
                .from('analytics_views')
                .select('views')
                .eq('content_type', itemType)
                .eq('content_id', itemId)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.log('Error getting views from database:', error);
                throw error;
            }

            return data ? data.views : 0;
        } catch (error) {
            // Fallback to localStorage
            console.log('Falling back to localStorage for views');
            const key = `analytics_views_${itemType}_${itemId}`;
            const views = localStorage.getItem(key);
            return views ? parseInt(views) : 0;
        }
    }

    async function renderProductsAnalytics(products = null) {
        try {
            console.log('Loading products analytics...');
            
            // Fetch products if not provided
            if (!products) {
                console.log('Fetching products from database...');
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    console.error('Error fetching products:', error);
                    throw error;
                }
                products = data || [];
                console.log('Fetched products:', products.length);
            }

            // Get real view counts for each product
            allProductsData = await Promise.all(products.map(async (product) => {
                const views = await getItemViews('product', product.id);
                return {
                    ...product,
                    views: views,
                    performance: views > 0 ? Math.min(100, Math.floor(views / 5) * 10) : 0 // Simple performance calculation
                };
            }));

            filteredProductsData = [...allProductsData];
            console.log('Generated products analytics data with real views:', allProductsData.length);

            // Update summary stats
            updateProductsStats();

            // Render products table
            renderProductsTable();

            // Setup search functionality
            setupProductsSearch();

        } catch (error) {
            console.error('Error loading products analytics:', error);
            // Show error in the table
            const tableBody = document.getElementById('productsAnalyticsTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fs-1"></i>
                            <p class="mt-2">Error loading products data: ${error.message}</p>
                            <button class="btn btn-primary" onclick="refreshProductsAnalytics()">Try Again</button>
                        </td>
                    </tr>
                `;
            }
        }
    }

    function updateProductsStats() {
        const totalProducts = filteredProductsData.length;
        const totalViews = filteredProductsData.reduce((sum, product) => sum + product.views, 0);
        const avgViews = totalProducts > 0 ? Math.round(totalViews / totalProducts) : 0;
        
        // Find top performing category
        const categoryViews = {};
        filteredProductsData.forEach(product => {
            const category = product.category || 'Other';
            categoryViews[category] = (categoryViews[category] || 0) + product.views;
        });
        
        const topCategory = Object.keys(categoryViews).reduce((a, b) => 
            categoryViews[a] > categoryViews[b] ? a : b, 'None'
        );

        // Update DOM
        document.getElementById('totalProducts').textContent = totalProducts.toLocaleString();
        document.getElementById('totalViews').textContent = totalViews.toLocaleString();
        document.getElementById('avgViewsPerProduct').textContent = avgViews.toLocaleString();
        document.getElementById('topPerformingCategory').textContent = topCategory;
    }

    function renderProductsTable() {
        const tableBody = document.getElementById('productsAnalyticsTable');
        
        if (filteredProductsData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-shopping-bag text-muted fs-1"></i>
                        <p class="mt-2 text-muted">No products found matching your search.</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Sort by created_at descending (newest first)
        const sortedProducts = [...filteredProductsData].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        tableBody.innerHTML = sortedProducts.map(product => {
            const performanceClass = product.performance >= 70 ? 'success' : 
                                   product.performance >= 40 ? 'warning' : 
                                   product.performance > 0 ? 'danger' : 'secondary';
            
            const performanceIcon = product.performance >= 70 ? 'fa-arrow-up' : 
                                  product.performance >= 40 ? 'fa-minus' : 
                                  product.performance > 0 ? 'fa-arrow-down' : 'fa-question';

            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="product-image me-3">
                                ${product.images && product.images.length > 0 
                                    ? `<img src="${product.images[0]}" alt="${product.title}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">`
                                    : `<div style="width: 40px; height: 40px; background: #e9ecef; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image text-muted"></i></div>`
                                }
                            </div>
                            <div>
                                <div class="fw-bold">${product.title}</div>
                                <small class="text-muted">${getRelativeTime(product.created_at)}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${product.category || 'Other'}</span>
                    </td>
                    <td>
                        <span class="fw-bold text-success">â‚¹${product.price?.toLocaleString() || '0'}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-eye text-muted me-1"></i>
                            <span class="fw-bold">${product.views.toLocaleString()}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 60px; height: 8px;">
                                <div class="progress-bar bg-${performanceClass}" role="progressbar" 
                                     style="width: ${product.performance}%"></div>
                            </div>
                            <span class="badge bg-${performanceClass}">
                                <i class="fas ${performanceIcon}"></i> ${product.performance}%
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewProductDetails('${product.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editProduct('${product.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function setupProductsSearch() {
        const searchInput = document.getElementById('productSearchInput');
        const clearButton = document.getElementById('clearProductSearch');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    filteredProductsData = [...allProductsData];
                } else {
                    filteredProductsData = allProductsData.filter(product => 
                        product.title.toLowerCase().includes(searchTerm) ||
                        product.category?.toLowerCase().includes(searchTerm) ||
                        product.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                updateProductsStats();
                renderProductsTable();
            });
        }

        if (clearButton) {
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                filteredProductsData = [...allProductsData];
                updateProductsStats();
                renderProductsTable();
            });
        }
    }

    // Refresh products analytics
    function refreshProductsAnalytics() {
        renderProductsAnalytics();
        showNotification('Products analytics refreshed successfully!', 'success');
    }

    // Product action handlers
    function viewProductDetails(productId) {
        const product = allProductsData.find(p => p.id === productId);
        if (product) {
            // Track view
            trackView('product', product.id, product.title);
            
            alert(`Product Details:\n\nTitle: ${product.title}\nCategory: ${product.category}\nPrice: â‚¹${product.price}\nViews: ${product.views}\nPerformance: ${product.performance}%\nCreated: ${new Date(product.created_at).toLocaleDateString()}`);
            
            // Refresh analytics to show updated view count
            setTimeout(() => {
                refreshProductsAnalytics();
            }, 500);
        }
    }

    function editProduct(productId) {
        showNotification('Edit product feature coming soon!', 'info');
    }

    // Notes Analytics Functions
    let allNotesData = [];
    let filteredNotesData = [];

    async function renderNotesAnalytics(notes = null) {
        try {
            console.log('=== NOTES ANALYTICS DEBUG START ===');
            console.log('Loading notes analytics...');
            
            // Fetch notes if not provided - try different approaches
            if (!notes) {
                console.log('Fetching notes from database...');
                
                // Debug: Check Supabase connection
                console.log('Supabase URL:', supabase.supabaseUrl);
                console.log('Supabase client:', !!supabase);
                
                // Try the standard approach first
                console.log('Attempt 1: Standard query with ordering');
                let { data, error } = await supabase
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                console.log('Attempt 1 result:', { data: data?.length, error: error?.message });
                
                // If error, try without ordering
                if (error) {
                    console.log('Attempt 2: Query without ordering');
                    console.log('Previous error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    ({ data, error } = await supabase.from('notes').select('*'));
                    console.log('Attempt 2 result:', { data: data?.length, error: error?.message });
                }
                
                // If still error, try with different approaches
                if (error) {
                    console.log('Attempt 3: Check table existence');
                    console.log('Previous error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Check what tables exist
                    const { data: tables, error: tableError } = await supabase
                        .from('information_schema.tables')
                        .select('table_name')
                        .eq('table_schema', 'public');
                    
                    console.log('Available tables:', tables?.map(t => t.table_name));
                    console.log('Table check error:', tableError?.message);
                    
                    // Try one more time with basic select
                    ({ data, error } = await supabase
                        .from('notes')
                        .select('id, title, subject, created_at')
                        .limit(10));
                    
                    console.log('Attempt 3 result:', { data: data?.length, error: error?.message });
                    
                    if (error) {
                        throw new Error(`All attempts failed. Last error: ${error.message}. Code: ${error.code}. Details: ${error.details || 'None'}`);
                    }
                }
                
                notes = data || [];
                console.log('Successfully fetched notes:', notes.length);
                console.log('Sample note:', notes[0]);
            }

            console.log('Processing notes for analytics...');

            // Get real view counts for each note
            allNotesData = await Promise.all(notes.map(async (note) => {
                const views = await getItemViews('note', note.id);
                return {
                    ...note,
                    views: views,
                    downloads: Math.floor(views * 0.3), // Estimate downloads as 30% of views
                    rating: views > 10 ? (3.5 + (views % 15) / 10).toFixed(1) : 0 // Dynamic rating based on popularity
                };
            }));

            filteredNotesData = [...allNotesData];
            console.log('Generated notes analytics data with real views:', allNotesData.length);
            console.log('=== NOTES ANALYTICS DEBUG END ===');

            // Update summary stats
            updateNotesStats();

            // Render notes table
            renderNotesTable();

            // Setup search functionality
            setupNotesSearch();

        } catch (error) {
            console.error('=== NOTES ANALYTICS ERROR ===');
            console.error('Full error object:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            console.error('=== ERROR END ===');
            
            // Show detailed error in the table
            const tableBody = document.getElementById('notesAnalyticsTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fs-1"></i>
                            <p class="mt-2"><strong>Error loading notes data:</strong></p>
                            <p class="small">${error.message}</p>
                            <p class="small text-muted">Check console for detailed error information</p>
                            <button class="btn btn-primary" onclick="refreshNotesAnalytics()">Try Again</button>
                        </td>
                    </tr>
                `;
            }
        }
    }

    function updateNotesStats() {
        const totalNotes = filteredNotesData.length;
        const totalViews = filteredNotesData.reduce((sum, note) => sum + note.views, 0);
        const avgViews = totalNotes > 0 ? Math.round(totalViews / totalNotes) : 0;
        
        // Find top performing subject
        const subjectViews = {};
        filteredNotesData.forEach(note => {
            const subject = note.subject || 'General';
            subjectViews[subject] = (subjectViews[subject] || 0) + note.views;
        });
        
        const topSubject = Object.keys(subjectViews).reduce((a, b) => 
            subjectViews[a] > subjectViews[b] ? a : b, 'None'
        );

        // Update DOM with proper error checking
        const totalNotesEl = document.getElementById('totalNotes');
        const totalNotesViewsEl = document.getElementById('totalNotesViews');
        const avgViewsPerNoteEl = document.getElementById('avgViewsPerNote');
        const topNotesSubjectEl = document.getElementById('topNotesSubject');
        
        if (totalNotesEl) totalNotesEl.textContent = totalNotes.toLocaleString();
        if (totalNotesViewsEl) totalNotesViewsEl.textContent = totalViews.toLocaleString();
        if (avgViewsPerNoteEl) avgViewsPerNoteEl.textContent = avgViews.toLocaleString();
        if (topNotesSubjectEl) topNotesSubjectEl.textContent = topSubject;
        
        console.log('Notes stats updated:', { totalNotes, totalViews, avgViews, topSubject });
    }

    function renderNotesTable() {
        const tableBody = document.getElementById('notesAnalyticsTable');
        
        if (filteredNotesData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-sticky-note text-muted fs-1"></i>
                        <p class="mt-2 text-muted">No notes found matching your search.</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Sort by created_at descending (newest first)
        const sortedNotes = [...filteredNotesData].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        tableBody.innerHTML = sortedNotes.map(note => {
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="note-icon me-3">
                                <i class="fas fa-file-alt text-primary" style="font-size: 24px;"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${note.title}</div>
                                <small class="text-muted">${getRelativeTime(note.created_at)}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-info">${note.subject || 'General'}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-eye text-muted me-1"></i>
                            <span class="fw-bold">${note.views.toLocaleString()}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-download text-success me-1"></i>
                            <span class="fw-bold">${note.downloads.toLocaleString()}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="me-2">
                                ${note.rating > 0 ? generateStarRating(parseFloat(note.rating)) : '<span class="text-muted">No ratings</span>'}
                            </span>
                            ${note.rating > 0 ? `<span class="fw-bold">${note.rating}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewNoteDetails('${note.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editNote('${note.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function setupNotesSearch() {
        const searchInput = document.getElementById('noteSearchInput');
        const clearButton = document.getElementById('clearNoteSearch');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    filteredNotesData = [...allNotesData];
                } else {
                    filteredNotesData = allNotesData.filter(note => 
                        note.title.toLowerCase().includes(searchTerm) ||
                        note.subject?.toLowerCase().includes(searchTerm) ||
                        note.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                updateNotesStats();
                renderNotesTable();
            });
        }

        if (clearButton) {
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                filteredNotesData = [...allNotesData];
                updateNotesStats();
                renderNotesTable();
            });
        }
    }

    // Refresh notes analytics
    function refreshNotesAnalytics() {
        renderNotesAnalytics();
        showNotification('Notes analytics refreshed successfully!', 'success');
    }

    // Note action handlers
    function viewNoteDetails(noteId) {
        const note = allNotesData.find(n => n.id === noteId);
        if (note) {
            // Track view
            trackView('note', note.id, note.title);
            
            alert(`Note Details:\n\nTitle: ${note.title}\nSubject: ${note.subject}\nViews: ${note.views}\nDownloads: ${note.downloads}\nRating: ${note.rating}/5.0\nCreated: ${new Date(note.created_at).toLocaleDateString()}`);
            
            // Refresh analytics to show updated view count
            setTimeout(() => {
                refreshNotesAnalytics();
            }, 500);
        }
    }

    function editNote(noteId) {
        showNotification('Edit note feature coming soon!', 'info');
    }

    // Rooms Analytics Functions
    let allRoomsData = [];
    let filteredRoomsData = [];

    async function renderRoomsAnalytics(rooms = null) {
        try {
            console.log('=== ROOMS ANALYTICS DEBUG START ===');
            console.log('Loading rooms analytics...');
            
            // Fetch rooms if not provided - try different approaches
            if (!rooms) {
                console.log('Fetching rooms from database...');
                
                // Debug: Check Supabase connection
                console.log('Supabase URL:', supabase.supabaseUrl);
                console.log('Supabase client:', !!supabase);
                
                // Try the standard approach first
                console.log('Attempt 1: Standard query with ordering');
                let { data, error } = await supabase
                    .from('rooms')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                console.log('Attempt 1 result:', { data: data?.length, error: error?.message });
                
                // If error, try without ordering
                if (error) {
                    console.log('Attempt 2: Query without ordering');
                    console.log('Previous error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    ({ data, error } = await supabase.from('rooms').select('*'));
                    console.log('Attempt 2 result:', { data: data?.length, error: error?.message });
                }
                
                // If still error, try with different approaches
                if (error) {
                    console.log('Attempt 3: Check table existence and basic select');
                    console.log('Previous error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Check what tables exist
                    const { data: tables, error: tableError } = await supabase
                        .from('information_schema.tables')
                        .select('table_name')
                        .eq('table_schema', 'public');
                    
                    console.log('Available tables:', tables?.map(t => t.table_name));
                    console.log('Table check error:', tableError?.message);
                    
                    // Try one more time with basic select
                    ({ data, error } = await supabase
                        .from('rooms')
                        .select('id, title, location, price, created_at')
                        .limit(10));
                    
                    console.log('Attempt 3 result:', { data: data?.length, error: error?.message });
                    
                    if (error) {
                        throw new Error(`All attempts failed. Last error: ${error.message}. Code: ${error.code}. Details: ${error.details || 'None'}`);
                    }
                }
                
                rooms = data || [];
                console.log('Successfully fetched rooms:', rooms.length);
                console.log('Sample room:', rooms[0]);
            }

            console.log('Processing rooms for analytics...');

            // Get real view counts for each room
            allRoomsData = await Promise.all(rooms.map(async (room) => {
                const views = await getItemViews('room', room.id);
                return {
                    ...room,
                    views: views,
                    bookings: Math.floor(views * 0.15), // Estimate bookings as 15% of views
                    occupancy: views > 0 ? Math.min(100, Math.floor(views * 2)) : 0 // Dynamic occupancy based on popularity
                };
            }));

            filteredRoomsData = [...allRoomsData];
            console.log('Generated rooms analytics data with real views:', allRoomsData.length);
            console.log('=== ROOMS ANALYTICS DEBUG END ===');

            // Update summary stats
            updateRoomsStats();

            // Render rooms table
            renderRoomsTable();

            // Setup search functionality
            setupRoomsSearch();

        } catch (error) {
            console.error('=== ROOMS ANALYTICS ERROR ===');
            console.error('Full error object:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            console.error('=== ERROR END ===');
            
            // Show detailed error in the table
            const tableBody = document.getElementById('roomsAnalyticsTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fs-1"></i>
                            <p class="mt-2"><strong>Error loading rooms data:</strong></p>
                            <p class="small">${error.message}</p>
                            <p class="small text-muted">Check console for detailed error information</p>
                            <button class="btn btn-primary" onclick="refreshRoomsAnalytics()">Try Again</button>
                        </td>
                    </tr>
                `;
            }
        }
    }

    function updateRoomsStats() {
        const totalRooms = filteredRoomsData.length;
        const totalViews = filteredRoomsData.reduce((sum, room) => sum + room.views, 0);
        const avgViews = totalRooms > 0 ? Math.round(totalViews / totalRooms) : 0;
        
        // Find top performing room type/location
        const locationViews = {};
        filteredRoomsData.forEach(room => {
            const location = room.location || 'Unknown';
            locationViews[location] = (locationViews[location] || 0) + room.views;
        });
        
        const topLocation = Object.keys(locationViews).reduce((a, b) => 
            locationViews[a] > locationViews[b] ? a : b, 'None'
        );

        // Update DOM with proper error checking
        const analyticsRoomsEl = document.getElementById('analyticsRooms');
        const totalRoomsViewsEl = document.getElementById('totalRoomsViews');
        const avgViewsPerRoomEl = document.getElementById('avgViewsPerRoom');
        const topRoomTypeEl = document.getElementById('topRoomType');
        
        if (analyticsRoomsEl) analyticsRoomsEl.textContent = totalRooms.toLocaleString();
        if (totalRoomsViewsEl) totalRoomsViewsEl.textContent = totalViews.toLocaleString();
        if (avgViewsPerRoomEl) avgViewsPerRoomEl.textContent = avgViews.toLocaleString();
        if (topRoomTypeEl) topRoomTypeEl.textContent = topLocation;
        
        console.log('Rooms stats updated:', { totalRooms, totalViews, avgViews, topLocation });
    }

    function renderRoomsTable() {
        const tableBody = document.getElementById('roomsAnalyticsTable');
        
        if (filteredRoomsData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-door-open text-muted fs-1"></i>
                        <p class="mt-2 text-muted">No rooms found matching your search.</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Sort by created_at descending (newest first)
        const sortedRooms = [...filteredRoomsData].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        tableBody.innerHTML = sortedRooms.map(room => {
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="room-icon me-3">
                                <i class="fas fa-door-open text-success" style="font-size: 24px;"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${room.title}</div>
                                <small class="text-muted">${getRelativeTime(room.created_at)}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-warning">${room.location || 'Not specified'}</span>
                    </td>
                    <td>
                        <span class="fw-bold text-success">â‚¹${room.price?.toLocaleString() || '0'}</span>
                        <small class="text-muted d-block">${room.period || 'per month'}</small>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-eye text-muted me-1"></i>
                            <span class="fw-bold">${room.views.toLocaleString()}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-check text-primary me-1"></i>
                            <span class="fw-bold">${room.bookings.toLocaleString()}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 60px; height: 8px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: ${Math.min(100, room.occupancy)}%"></div>
                            </div>
                            <span class="badge bg-info">${room.occupancy}%</span>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewRoomDetails('${room.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editRoom('${room.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function setupRoomsSearch() {
        const searchInput = document.getElementById('roomSearchInput');
        const clearButton = document.getElementById('clearRoomSearch');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    filteredRoomsData = [...allRoomsData];
                } else {
                    filteredRoomsData = allRoomsData.filter(room => 
                        room.title.toLowerCase().includes(searchTerm) ||
                        room.location?.toLowerCase().includes(searchTerm) ||
                        room.description?.toLowerCase().includes(searchTerm)
                    );
                }
                
                updateRoomsStats();
                renderRoomsTable();
            });
        }

        if (clearButton) {
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                filteredRoomsData = [...allRoomsData];
                updateRoomsStats();
                renderRoomsTable();
            });
        }
    }

    // Refresh rooms analytics
    function refreshRoomsAnalytics() {
        renderRoomsAnalytics();
        showNotification('Rooms analytics refreshed successfully!', 'success');
    }

    // Room action handlers
    function viewRoomDetails(roomId) {
        const room = allRoomsData.find(r => r.id === roomId);
        if (room) {
            // Track view
            trackView('room', room.id, room.title);
            
            alert(`Room Details:\n\nTitle: ${room.title}\nLocation: ${room.location}\nPrice: â‚¹${room.price} ${room.period || 'per month'}\nViews: ${room.views}\nBookings: ${room.bookings}\nOccupancy: ${room.occupancy}%\nCreated: ${new Date(room.created_at).toLocaleDateString()}`);
            
            // Refresh analytics to show updated view count
            setTimeout(() => {
                refreshRoomsAnalytics();
            }, 500);
        }
    }

    function editRoom(roomId) {
        showNotification('Edit room feature coming soon!', 'info');
    }

    // Helper function for relative time
    function getRelativeTime(dateString) {
        const now = new Date();
        const past = new Date(dateString);
        const diffInSeconds = Math.floor((now - past) / 1000);
        
        if (diffInSeconds < 60) return 'just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
        return `${Math.floor(diffInSeconds / 2592000)}mo ago`;
    }

    // Helper function for star rating
    function generateStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        let stars = '';
        
        // Full stars
        for (let i = 0; i < fullStars; i++) {
            stars += '<i class="fas fa-star text-warning"></i>';
        }
        
        // Half star
        if (hasHalfStar) {
            stars += '<i class="fas fa-star-half-alt text-warning"></i>';
        }
        
        // Empty stars
        for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="far fa-star text-warning"></i>';
        }
        
        return stars;
    }

    // Export data function
    async function exportData() {
        try {
            const exportBtn = event.target;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            exportBtn.disabled = true;

            const [
                { data: users = [] },
                { data: products = [] },
                { data: notes = [] },
                { data: rooms = [] },
                { data: transactions = [] }
            ] = await Promise.all([
                supabase.from('users').select('*'),
                supabase.from('products').select('*'),
                supabase.from('notes').select('*'),
                supabase.from('rooms').select('*'),
                supabase.from('transactions').select('*').throwOnError(false)
            ]);

            const exportData = {
                exportDate: new Date().toISOString(),
                summary: {
                    users: users.length,
                    products: products.length,
                    notes: notes.length,
                    rooms: rooms.length,
                    transactions: transactions.length
                },
                data: {
                    users,
                    products,
                    notes,
                    rooms,
                    transactions
                }
            };

            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `studx-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            exportBtn.innerHTML = '<i class="fas fa-download"></i> Export Data';
            exportBtn.disabled = false;
            alert('Data exported successfully!');

        } catch (error) {
            console.error('Export failed:', error);
            alert('Export failed: ' + error.message);
        }
    }

    // Products Page: Fetch all items and render as cards
    async function renderProductsPage() {
        let allItems = [];
        let selectedItems = new Set();
        
        try {
            const [{ data: products = [] } = {}, { data: notes = [] } = {}, { data: rooms = [] } = {}] = await Promise.all([
                supabase.from('products').select('*').order('created_at', { ascending: false }).throwOnError(false),
                supabase.from('notes').select('*').order('created_at', { ascending: false }).throwOnError(false),
                supabase.from('rooms').select('*').order('created_at', { ascending: false }).throwOnError(false)
            ]);
            
            products.forEach(p => p._type = 'product');
            notes.forEach(n => n._type = 'note');
            rooms.forEach(r => r._type = 'room');
            allItems = [...products, ...notes, ...rooms];
            
            // Sort all items by created_at in descending order (newest first)
            allItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } catch (err) {
            document.getElementById('productCards').innerHTML = `<div class='alert alert-danger'>Failed to load items: ${err.message}</div>`;
            return;
        }

        function updateBulkButtons() {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = selectedItems.size === 0;
                bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedItems.size})`;
            }
            
            if (selectAllBtn) {
                const allSelected = selectedItems.size === allItems.length;
                selectAllBtn.innerHTML = allSelected ? 
                    '<i class="fas fa-square"></i> Deselect All' : 
                    '<i class="fas fa-check-square"></i> Select All';
            }
        }

        function renderCards(filter = '', sortBy = 'newest') {
            let filtered = allItems.filter(item => {
                const search = filter.toLowerCase();
                return Object.values(item).join(' ').toLowerCase().includes(search);
            });
            
            // Sort filtered items based on sortBy parameter
            switch(sortBy) {
                case 'newest':
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'name':
                    filtered.sort((a, b) => {
                        const nameA = (a.title || a.name || '').toLowerCase();
                        const nameB = (b.title || b.name || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'type':
                    filtered.sort((a, b) => a._type.localeCompare(b._type));
                    break;
            }
            
            if (!filtered.length) {
                document.getElementById('productCards').innerHTML = `<div class='alert alert-info'>No items found.</div>`;
                return;
            }
            
            document.getElementById('productCards').innerHTML = filtered.map(item => {
                let imgSrc = item.image || item.image_url || item.img || (item.images && Array.isArray(item.images) && item.images.length > 0 ? item.images[0] : '');
                let imgTag = imgSrc ? `<img src='${imgSrc}' alt='Image' class='card-img-top' style='object-fit:cover;height:180px;'>` : `<div style='height:180px;background:#eee;display:flex;align-items:center;justify-content:center;color:#aaa;'>No Image</div>`;
                const isSelected = selectedItems.has(item.id);
                
                return `
                <div class='col-md-4'>
                    <div class='card product-card h-100 position-relative ${isSelected ? 'border-primary' : ''}' style='cursor:pointer;' data-id='${item.id}' data-type='${item._type}'>
                        <div class="form-check position-absolute" style="top: 10px; left: 10px; z-index: 10;">
                            <input class="form-check-input item-checkbox" type="checkbox" data-id="${item.id}" ${isSelected ? 'checked' : ''}>
                        </div>
                        <button class='btn btn-sm btn-danger delete-product-btn' data-id='${item.id}' data-type='${item._type}' title='Delete'>&times;</button>
                        ${imgTag}
                        <div class='card-body'>
                            <h5 class='card-title'>${item.title || item.name || '(no title)'}</h5>
                            <p class='card-text'><b>Type:</b> <span class="badge bg-secondary">${item._type}</span></p>
                            <p class='card-text'><b>ID:</b> ${item.id}</p>
                            <p class='card-text'><b>Created:</b> ${new Date(item.created_at).toLocaleDateString()} <small class="text-muted">(${getRelativeTime(item.created_at)})</small></p>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Add checkbox handlers
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    const id = checkbox.getAttribute('data-id');
                    if (checkbox.checked) {
                        selectedItems.add(id);
                    } else {
                        selectedItems.delete(id);
                    }
                    updateBulkButtons();
                    renderCards(filter);
                };
            });
            
            // Add individual delete handlers
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) return;
                    
                    const id = btn.getAttribute('data-id');
                    const type = btn.getAttribute('data-type');
                    let table = type === 'note' ? 'notes' : (type === 'room' ? 'rooms' : 'products');
                    
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;
                    
                    try {
                        const { error } = await supabase.from(table).delete().eq('id', id);
                        if (error) {
                            alert('Failed to delete: ' + error.message);
                            btn.innerHTML = '&times;';
                            btn.disabled = false;
                            return;
                        }
                        
                        const itemIndex = allItems.findIndex(item => item.id === id && item._type === type);
                        if (itemIndex !== -1) {
                            allItems.splice(itemIndex, 1);
                        }
                        
                        selectedItems.delete(id);
                        const searchValue = document.getElementById('productSearch')?.value || '';
                        const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                        renderCards(searchValue, sortValue);
                        alert('Item deleted successfully!');
                    } catch (err) {
                        alert('Error deleting item: ' + err.message);
                        btn.innerHTML = '&times;';
                        btn.disabled = false;
                    }
                };
            });
            
            updateBulkButtons();
        }

        renderCards();
        
        // Setup sorting
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                const searchValue = document.getElementById('productSearch')?.value || '';
                renderCards(searchValue, e.target.value);
            });
        }
        
        // Setup bulk operations
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        
        if (bulkDeleteBtn) {
            bulkDeleteBtn.onclick = async () => {
                if (selectedItems.size === 0) return;
                
                if (!confirm(`Are you sure you want to delete ${selectedItems.size} items? This action cannot be undone.`)) return;
                
                bulkDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                bulkDeleteBtn.disabled = true;
                
                try {
                    const promises = [];
                    selectedItems.forEach(id => {
                        const item = allItems.find(i => i.id === id);
                        if (item) {
                            const table = item._type === 'note' ? 'notes' : (item._type === 'room' ? 'rooms' : 'products');
                            promises.push(supabase.from(table).delete().eq('id', id));
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    allItems = allItems.filter(item => !selectedItems.has(item.id));
                    selectedItems.clear();
                    
                    const searchValue = document.getElementById('productSearch')?.value || '';
                    const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                    renderCards(searchValue, sortValue);
                    alert('Items deleted successfully!');
                } catch (error) {
                    alert('Error deleting items: ' + error.message);
                }
                
                bulkDeleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete Selected';
                bulkDeleteBtn.disabled = true;
            };
        }
        
        if (selectAllBtn) {
            selectAllBtn.onclick = () => {
                const allSelected = selectedItems.size === allItems.length;
                if (allSelected) {
                    selectedItems.clear();
                } else {
                    allItems.forEach(item => selectedItems.add(item.id));
                }
                updateBulkButtons();
                const searchValue = document.getElementById('productSearch')?.value || '';
                const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                renderCards(searchValue, sortValue);
            };
        }
        
        // Search functionality
        const searchInput = document.getElementById('productSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const sortValue = document.getElementById('sortSelect')?.value || 'newest';
                renderCards(e.target.value, sortValue);
            });
        }
    }

    // Users Page: Fetch all users from users table
    async function renderUsersPage() {
        try {
            const { data: users = [], error } = await supabase.from('users').select('*');
            if (error) throw error;
            
            if (!users.length) {
                document.getElementById('usersTable').innerHTML = `<div class='alert alert-info'>No users found.</div>`;
                return;
            }
            
            document.getElementById('usersTable').innerHTML = `
                <div class='table-responsive'>
                    <table class='table table-striped'>
                        <thead>
                            <tr>
                                ${Object.keys(users[0]).map(k => `<th>${k}</th>`).join('')}
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr id='user-row-${u.id}'>
                                    ${Object.values(u).map(v => `<td>${v || 'N/A'}</td>`).join('')}
                                    <td>
                                        <button class='btn btn-sm btn-danger delete-user-btn' data-id='${u.id}'>
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add delete handlers
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
                    
                    const id = btn.getAttribute('data-id');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;
                    
                    try {
                        const { error } = await supabase.from('users').delete().eq('id', id);
                        if (error) {
                            alert('Failed to delete user: ' + error.message);
                            btn.innerHTML = 'Delete';
                            btn.disabled = false;
                            return;
                        }
                        
                        const row = document.getElementById(`user-row-${id}`);
                        if (row) {
                            row.remove();
                        }
                        
                        alert('User deleted successfully!');
                        
                        const tableBody = document.querySelector('#usersTable tbody');
                        if (tableBody && tableBody.children.length === 0) {
                            document.getElementById('usersTable').innerHTML = `<div class='alert alert-info'>No users found.</div>`;
                        }
                    } catch (err) {
                        alert('Error deleting user: ' + err.message);
                        btn.innerHTML = 'Delete';
                        btn.disabled = false;
                    }
                };
            });
        } catch (err) {
            document.getElementById('usersTable').innerHTML = `<div class='alert alert-danger'>Failed to load users: ${err.message}</div>`;
        }
    }

    // Transaction History Functions
    async function loadTransactionHistory() {
        try {
            console.log('ðŸ“Š Loading transaction history...');
            
            // Load all transactions first
            const { data: transactions, error } = await supabase
                .from('transactions')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(100);

            if (error) throw error;

            // For each transaction, fetch the related item and user details separately
            const enrichedTransactions = await Promise.all(transactions.map(async (transaction) => {
                let item = null;
                let buyer = null;
                let seller = null;

                // Fetch item details based on item_type
                try {
                    if (transaction.item_type === 'note') {
                        const { data: noteData } = await supabase
                            .from('notes')
                            .select('id, title')
                            .eq('id', transaction.listing_id)
                            .single();
                        item = noteData ? { ...noteData, type: 'note' } : null;
                    } else if (transaction.item_type === 'room') {
                        const { data: roomData } = await supabase
                            .from('rooms')
                            .select('id, hostel_name, room_type')
                            .eq('id', transaction.listing_id)
                            .single();
                        item = roomData ? { ...roomData, type: 'room', title: `${roomData.hostel_name} - ${roomData.room_type}` } : null;
                    } else {
                        const { data: productData } = await supabase
                            .from('products')
                            .select('id, title, name')
                            .eq('id', transaction.listing_id)
                            .single();
                        item = productData ? { ...productData, type: 'product', title: productData.title || productData.name } : null;
                    }
                } catch (itemError) {
                    console.error('Error fetching item:', itemError);
                }

                // Fetch buyer details
                try {
                    const { data: buyerData } = await supabase
                        .from('users')
                        .select('id, full_name, phone, email')
                        .eq('id', transaction.buyer_id)
                        .single();
                    buyer = buyerData;
                } catch (buyerError) {
                    console.error('Error fetching buyer:', buyerError);
                }

                // Fetch seller details
                try {
                    const { data: sellerData } = await supabase
                        .from('users')
                        .select('id, full_name, phone, email')
                        .eq('id', transaction.seller_id)
                        .single();
                    seller = sellerData;
                } catch (sellerError) {
                    console.error('Error fetching seller:', sellerError);
                }

                return {
                    ...transaction,
                    item,
                    buyer,
                    seller
                };
            }));

            // Update summary cards
            const completed = enrichedTransactions.filter(t => t.status === 'completed');
            const pending = enrichedTransactions.filter(t => t.status === 'pending');
            const totalVolume = enrichedTransactions
                .filter(t => t.status === 'completed')
                .reduce((sum, t) => sum + t.amount, 0);
            const platformRevenue = enrichedTransactions
                .filter(t => t.status === 'completed')
                .reduce((sum, t) => sum + (t.amount * 0.05), 0);

            // Update UI
            const safeUpdate = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };

            safeUpdate('completedTransactions', completed.length);
            safeUpdate('pendingTransactions', pending.length);
            safeUpdate('totalVolume', `â‚¹${totalVolume.toLocaleString()}`);
            safeUpdate('platformRevenue', `â‚¹${Math.round(platformRevenue).toLocaleString()}`);

            // Populate table
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;

            if (enrichedTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = enrichedTransactions.map(transaction => {
                // Get item name based on type
                let itemName = 'Unknown Item';
                if (transaction.item) {
                    itemName = transaction.item.title || transaction.item.name || 'Untitled Item';
                }

                const buyerName = transaction.buyer?.full_name || 'Unknown Buyer';
                const buyerPhone = transaction.buyer?.phone || 'N/A';
                const statusColor = {
                    'completed': 'success',
                    'pending': 'warning',
                    'failed': 'danger'
                }[transaction.status] || 'secondary';

                const date = new Date(transaction.created_at).toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <tr>
                        <td><code>${transaction.id.substring(0, 8)}...</code></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-2">${transaction.listing_type}</span>
                                <span title="${itemName}">${itemName.length > 30 ? itemName.substring(0, 30) + '...' : itemName}</span>
                            </div>
                        </td>
                        <td>${buyerName}</td>
                        <td><a href="tel:${buyerPhone}" class="text-decoration-none">${buyerPhone}</a></td>
                        <td><strong>â‚¹${transaction.amount.toLocaleString()}</strong></td>
                        <td><span class="badge bg-${statusColor}">${transaction.status}</span></td>
                        <td><small>${date}</small></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetails('${transaction.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${transaction.status === 'pending' ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="markTransactionCompleted('${transaction.id}')" title="Mark Completed">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Setup filters
            setupTransactionFilters(enrichedTransactions);

        } catch (error) {
            console.error('Error loading transaction history:', error);
            const tbody = document.getElementById('transactionsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading transactions</td></tr>';
            }
        }
    }

    // Setup transaction filters
    function setupTransactionFilters(allTransactions) {
        const filterSelect = document.getElementById('transactionFilter');
        const dateInput = document.getElementById('transactionDate');
        
        if (filterSelect) {
            filterSelect.addEventListener('change', () => filterTransactions(allTransactions));
        }
        
        if (dateInput) {
            dateInput.addEventListener('change', () => filterTransactions(allTransactions));
        }
    }

    // Filter transactions
    function filterTransactions(allTransactions) {
        const filter = document.getElementById('transactionFilter')?.value || 'all';
        const date = document.getElementById('transactionDate')?.value;
        
        let filtered = allTransactions;
        
        // Filter by status
        if (filter !== 'all') {
            filtered = filtered.filter(t => t.status === filter);
        }
        
        // Filter by date
        if (date) {
            const filterDate = new Date(date).toDateString();
            filtered = filtered.filter(t => new Date(t.created_at).toDateString() === filterDate);
        }
        
        // Update table with filtered results
        updateTransactionTable(filtered);
    }

    // Update transaction table
    function updateTransactionTable(transactions) {
        const tbody = document.getElementById('transactionsTableBody');
        if (!tbody) return;
        
        if (transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No transactions match the selected filters</td></tr>';
            return;
        }
        
        // Reuse the same table generation logic...
        // (Implementation same as in loadTransactionHistory)
    }

    // View transaction details
    function viewTransactionDetails(transactionId) {
        showNotification(`Viewing details for transaction ${transactionId.substring(0, 8)}...`, 'info');
        // Implementation for viewing transaction details modal
    }

    // Mark transaction as completed
    async function markTransactionCompleted(transactionId) {
        try {
            const { error } = await supabase
                .from('transactions')
                .update({ status: 'completed' })
                .eq('id', transactionId);
                
            if (error) throw error;
            
            showNotification('Transaction marked as completed', 'success');
            loadTransactionHistory(); // Reload the table
        } catch (error) {
            console.error('Error updating transaction:', error);
            showNotification('Error updating transaction', 'error');
        }
    }

    // Export transactions
    function exportTransactions() {
        showNotification('Export functionality coming soon!', 'info');
        // Implementation for CSV/Excel export
    }

    // Enhanced Sponsorship Management Functions
    async function renderSponsorshipPage() {
        try {
            console.log('ðŸŒŸ Loading sponsorship interface...');
            
            // Initialize selected items array
            window.selectedItems = [];
            
            // Load current sponsored items
            await loadCurrentSponsoredItems();
            
            console.log('âœ… Sponsorship interface loaded successfully!');
            
        } catch (error) {
            console.error('Error loading sponsorship page:', error);
            document.getElementById('currentSponsoredItems').innerHTML = 
                '<div class="text-center py-4"><i class="fas fa-exclamation-triangle text-danger" style="font-size: 2rem;"></i><p class="text-danger mt-2">Error loading sponsored items</p></div>';
        }
    }

    // Load current sponsored items
    async function loadCurrentSponsoredItems() {
        const container = document.getElementById('currentSponsoredItems');
        
        try {
            // Show loading state
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading sponsored items...</p>
                </div>
            `;

            // Fetch sponsorship data
            const { data: sponsorships, error } = await supabase
                .from('sponsorship_sequences')
                .select('*')
                .order('slot', { ascending: true });

            if (error) throw error;

            if (!sponsorships || sponsorships.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-star" style="font-size: 3rem; color: #dee2e6;"></i>
                        <p class="text-muted mt-3">No sponsored items yet</p>
                        <button class="btn btn-primary" onclick="openAddSponsorModal()">
                            <i class="fas fa-plus me-2"></i>Add First Sponsor
                        </button>
                    </div>
                `;
                return;
            }

            // Fetch item details for each sponsorship
            const enrichedSponsorships = await Promise.all(sponsorships.map(async (sponsor) => {
                let itemData = null;
                try {
                    const table = sponsor.item_type === 'note' ? 'notes' : 
                                 sponsor.item_type === 'room' ? 'rooms' : 'products';
                    
                    const { data } = await supabase
                        .from(table)
                        .select('*')
                        .eq('id', sponsor.item_id)
                        .single();
                    
                    itemData = data ? { ...data, type: sponsor.item_type } : null;
                } catch (error) {
                    console.error('Error fetching item details:', error);
                }

                return { ...sponsor, itemData };
            }));

            // Render sponsored items
            container.innerHTML = enrichedSponsorships.map((sponsor) => {
                const item = sponsor.itemData;
                if (!item) {
                    return `
                        <div class="col-md-4 mb-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span class="badge bg-warning">Slot ${sponsor.slot}</span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeSponsor(${sponsor.id})">Remove</button>
                                    </div>
                                    <div class="text-center text-danger mt-3">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                        <p class="mt-2">Item not found</p>
                                        <small>ID: ${sponsor.item_id} | Type: ${sponsor.item_type}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const title = item.title || item.name || item.hostel_name || 'Untitled';
                const price = item.price || item.fees || 0;
                const imageUrl = (Array.isArray(item.images) && item.images[0]) || 
                               (Array.isArray(item.image_urls) && item.image_urls[0]) || 
                               'https://via.placeholder.com/300x200?text=No+Image';

                const typeColors = {
                    'note': 'bg-info',
                    'room': 'bg-warning', 
                    'product': 'bg-success'
                };

                return `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="${imageUrl}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${title}">
                                <span class="position-absolute top-0 start-0 badge bg-primary m-2">Slot ${sponsor.slot}</span>
                                <span class="position-absolute top-0 end-0 badge ${typeColors[item.type]} m-2">${item.type}</span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">${title}</h6>
                                <p class="text-success fw-bold">â‚¹${price.toLocaleString()}</p>
                                <small class="text-muted">Added: ${new Date(sponsor.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" onclick="editSequence('${sponsor.id}', ${sponsor.slot})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeSponsor('${sponsor.id}')">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading sponsored items:', error);
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                    <p class="text-danger mt-2">Error loading sponsored items</p>
                    <button class="btn btn-outline-primary mt-2" onclick="loadCurrentSponsoredItems()">
                        <i class="fas fa-sync me-1"></i>Try Again
                    </button>
                </div>
            `;
        }
    }

    // Open add sponsor modal
    function openAddSponsorModal() {
        // Clear any previous selections
        window.selectedItems = [];
        
        // Load available items
        loadAvailableItemsForSponsor();
        
        // Show modal - use the correct modal ID
        const modal = new bootstrap.Modal(document.getElementById('newSponsorshipModal'));
        modal.show();
    }

    // Load available items for sponsorship
    async function loadAvailableItemsForSponsor() {
        const container = document.getElementById('availableItemsGrid');
        
        try {
            // Show loading
            container.innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading items...</p>
                </div>
            `;

            // Load existing sponsorships to check for duplicates
            const { data: existingSponsors } = await supabase
                .from('sponsorship_sequences')
                .select('item_id, item_type');
            
            const sponsoredItems = new Set(
                (existingSponsors || []).map(sponsor => `${sponsor.item_type}-${sponsor.item_id}`)
            );

            // Load all items with better error handling
            const results = await Promise.allSettled([
                supabase.from('notes').select('*').limit(50),
                supabase.from('rooms').select('*').limit(50),
                supabase.from('products').select('*').limit(50)
            ]);

            // Handle results safely
            const notesResult = results[0].status === 'fulfilled' ? results[0].value : { data: [] };
            const roomsResult = results[1].status === 'fulfilled' ? results[1].value : { data: [] };
            const productsResult = results[2].status === 'fulfilled' ? results[2].value : { data: [] };

            // Log any errors
            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    const tableName = ['notes', 'rooms', 'products'][index];
                    console.error(`Error loading ${tableName}:`, result.reason);
                }
            });

            // Log the data we're getting for debugging
            console.log('Notes data:', notesResult.data?.length || 0, 'items');
            console.log('Rooms data:', roomsResult.data?.length || 0, 'items');
            console.log('Products data:', productsResult.data?.length || 0, 'items');

            const allItems = [
                ...(notesResult.data || []).map(item => ({ 
                    ...item, 
                    type: 'note',
                    title: item.title || item.name || 'Untitled Note',
                    price: item.price || 0,
                    images: item.images || []
                })),
                ...(roomsResult.data || []).map(item => ({ 
                    ...item, 
                    type: 'room', 
                    title: item.hostel_name || item.title || item.name || 'Untitled Room',
                    price: item.fees || item.price || 0,
                    images: item.image_urls || item.images || []
                })),
                ...(productsResult.data || []).map(item => ({ 
                    ...item, 
                    type: 'product', 
                    title: item.name || item.title || 'Untitled Product',
                    price: item.price || 0,
                    images: item.images || []
                }))
            ];

            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No items found</p>
                    </div>
                `;
                return;
            }

            // Render items
            const itemsHTML = allItems.map(item => {
                const originalTitle = item.title || 'Untitled';
                const safeTitleForJs = originalTitle.replace(/'/g, "\\'");
                const price = item.price || 0;
                const image = (Array.isArray(item.images) && item.images[0]) || 'https://via.placeholder.com/150';
                
                // Check if this item is already sponsored
                const dbType = item.type === 'product' ? 'product' : item.type;
                const isSponsored = sponsoredItems.has(`${dbType}-${item.id}`);
                
                const typeColors = {
                    'note': 'primary',
                    'room': 'warning', 
                    'product': 'success'
                };

                const onclickHandler = isSponsored ? 'void(0)' : `selectItemForSponsor('${item.type}', '${item.id}', '${safeTitleForJs}')`;

                return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card item-card h-100 ${isSponsored ? 'border-warning bg-light' : ''}" 
                             onclick="${onclickHandler}"
                             style="${isSponsored ? 'cursor: not-allowed; opacity: 0.7;' : 'cursor: pointer;'}">
                            ${isSponsored ? '<div class="position-absolute top-0 end-0 p-2"><i class="fas fa-star text-warning" title="Already Sponsored"></i></div>' : ''}
                            <img src="${image}" class="card-img-top" style="height: 120px; object-fit: cover;" alt="${originalTitle}">
                            <div class="card-body p-2">
                                <h6 class="card-title text-truncate">${originalTitle}</h6>
                                <span class="badge bg-${typeColors[item.type]} mb-2">${item.type}</span>
                                ${price > 0 ? `<div class="fw-bold text-success">â‚¹${price}</div>` : ''}
                                ${isSponsored ? '<small class="text-warning"><i class="fas fa-star me-1"></i>Already Sponsored</small>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = itemsHTML;

        } catch (error) {
            console.error('Error loading items:', error);
            container.innerHTML = `
                <div class="col-12 text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                    <p class="text-danger">Error loading items</p>
                </div>
            `;
        }
    }

    // Select item for sponsorship (supports multi-select)
    function selectItemForSponsor(type, id, title) {
        try {
            // Initialize if needed
            if (!window.selectedItems) {
                window.selectedItems = [];
            }

            const itemKey = `${type}-${id}`;
            const clickedCard = event.currentTarget || event.target.closest('.item-card');
            
            // Check if item is already selected
            const existingIndex = window.selectedItems.findIndex(item => `${item.type}-${item.id}` === itemKey);
            
            if (existingIndex >= 0) {
                // Deselect item
                window.selectedItems.splice(existingIndex, 1);
                if (clickedCard) {
                    clickedCard.style.borderColor = '';
                    clickedCard.style.backgroundColor = '';
                    clickedCard.classList.remove('selected');
                }
            } else {
                // Select item
                window.selectedItems.push({ type, id, title });
                if (clickedCard) {
                    clickedCard.style.borderColor = '#28a745';
                    clickedCard.style.backgroundColor = '#d4edda';
                    clickedCard.classList.add('selected');
                }
            }

            // Update button state
            updateAddSponsorButton();

        } catch (error) {
            console.error('Error in selectItemForSponsor:', error);
        }
    }

    // Update add sponsor button
    function updateAddSponsorButton() {
        const button = document.getElementById('addSelectedSponsors');
        const count = window.selectedItems ? window.selectedItems.length : 0;
        
        if (button) {
            if (count === 0) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-star me-2"></i>Select Items First';
                button.className = 'btn btn-success btn-lg';
            } else {
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-star me-2"></i>Add ${count} Item${count > 1 ? 's' : ''} as Sponsor${count > 1 ? 's' : ''}`;
                button.className = 'btn btn-success btn-lg';
            }
        }
    }

    // Process selected sponsors (called by the modal button)
    function processSelectedSponsors() {
        return addSelectedSponsors();
    }

    // Clear all new selections (called by the clear button)
    function clearAllNewSelections() {
        return clearAllSelections();
    }

    // Filter available items (called by search input and filter)
    function filterAvailableItems() {
        return searchSponsorItems();
    }

    // Add selected items as sponsors
    async function addSelectedSponsors() {
        if (!window.selectedItems || window.selectedItems.length === 0) {
            alert('Please select at least one item first');
            return;
        }

        const button = document.getElementById('addSelectedSponsors');
        const originalText = button?.innerHTML || '';
        
        try {
            // Show loading
            if (button) {
                button.disabled = true;
                button.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Adding...';
            }

            // Get next available slot
            const { data: existingSponsors } = await supabase
                .from('sponsorship_sequences')
                .select('slot')
                .order('slot', { ascending: false })
                .limit(1);

            let nextSlot = existingSponsors && existingSponsors.length > 0 ? existingSponsors[0].slot + 1 : 1;

            // Add each selected item
            const sponsorshipData = window.selectedItems.map(item => ({
                item_id: item.id,
                item_type: item.type,
                slot: nextSlot++,
                created_at: new Date().toISOString()
            }));

            const { error } = await supabase
                .from('sponsorship_sequences')
                .insert(sponsorshipData);

            if (error) throw error;

            // Success
            const count = window.selectedItems.length;
            const message = count === 1 ? 
                `"${window.selectedItems[0].title}" added as sponsor!` : 
                `${count} items added as sponsors!`;
            
            alert(message);

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newSponsorshipModal'));
            if (modal) modal.hide();

            // Refresh the page
            await loadCurrentSponsoredItems();

            // Clear selections
            window.selectedItems = [];

        } catch (error) {
            console.error('Error adding sponsors:', error);
            alert('Error adding sponsors: ' + error.message);
        } finally {
            // Reset button
            if (button) {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
    }

    // Remove sponsor
    async function removeSponsor(sponsorId) {
        if (!confirm('Are you sure you want to remove this sponsored item?')) return;

        try {
            const { error } = await supabase
                .from('sponsorship_sequences')
                .delete()
                .eq('id', sponsorId);

            if (error) throw error;

            alert('Sponsored item removed successfully!');
            await loadCurrentSponsoredItems();

        } catch (error) {
            console.error('Error removing sponsor:', error);
            alert('Error removing sponsor: ' + error.message);
        }
    }

    // Edit sequence (change slot number)
    async function editSequence(sponsorId, currentSlot) {
        const newSlot = prompt(`Enter new sequence number (current: ${currentSlot}):`);
        if (!newSlot || isNaN(newSlot) || newSlot < 1) return;

        try {
            const { error } = await supabase
                .from('sponsorship_sequences')
                .update({ slot: parseInt(newSlot) })
                .eq('id', sponsorId);

            if (error) throw error;

            alert('Sequence updated successfully!');
            await loadCurrentSponsoredItems();

        } catch (error) {
            console.error('Error updating sequence:', error);
            alert('Error updating sequence: ' + error.message);
        }
    }

    // Search functionality for modal
    function searchSponsorItems() {
        const searchTerm = document.getElementById('itemSearchInput')?.value.toLowerCase() || '';
        const typeFilter = document.getElementById('itemTypeFilter')?.value || '';
        
        const items = document.querySelectorAll('#availableItemsGrid .item-card');
        
        items.forEach(card => {
            const title = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
            const type = card.querySelector('.badge')?.textContent.toLowerCase().trim() || '';
            
            const matchesSearch = !searchTerm || title.includes(searchTerm);
            const matchesType = !typeFilter || type.includes(typeFilter.toLowerCase());

            if (matchesSearch && matchesType) {
                card.parentElement.style.display = 'block';
            } else {
                card.parentElement.style.display = 'none';
            }
        });
    }

    // Make functions globally available
    window.openAddSponsorModal = openAddSponsorModal;
    window.selectItemForSponsor = selectItemForSponsor;
    window.addSelectedSponsors = addSelectedSponsors;
    window.removeSponsor = removeSponsor;
    window.editSequence = editSequence;
    window.searchSponsorItems = searchSponsorItems;
    window.loadCurrentSponsoredItems = loadCurrentSponsoredItems;

    console.log('âœ… Sponsorship management system loaded successfully!');

    // Simple notification function
    function showNotification(message, type = 'info') {
        alert(message);
    }

    // Missing function definitions for compatibility
    function confirmAddSponsor() {
        // Redirect to our new function
        return addSelectedSponsors();
    }

    function openSponsorshipModal() {
        // Redirect to our new function
        return openAddSponsorModal();
    }

    function clearAllSelections() {
        // Clear selections
        if (window.selectedItems) {
            window.selectedItems = [];
        }
        
        // Remove visual selection from all cards
        document.querySelectorAll('.item-card').forEach(card => {
            card.classList.remove('selected');
            card.style.borderColor = '';
            card.style.backgroundColor = '';
        });
        
        updateAddSponsorButton();
        showNotification('All selections cleared', 'info');
    }

    function searchItems() {
        return searchSponsorItems();
    }

    // ========================================
    // ENHANCED ADMIN PANEL FEATURES
    // ========================================

    // Theme Toggle Functionality
    function initThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const icon = themeToggle.querySelector('i');
        
        // Load saved theme
        const savedTheme = localStorage.getItem('adminTheme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            icon.className = 'fas fa-sun';
        }
        
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            
            // Update icon
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            // Save preference
            localStorage.setItem('adminTheme', isDark ? 'dark' : 'light');
            
            // Show notification
            showNotification(
                `Switched to ${isDark ? 'dark' : 'light'} mode`, 
                'success'
            );
        });
    }

    // Mobile Menu Functionality
    function initMobileMenu() {
        const mobileToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.querySelector('.sidebar');
        
        if (mobileToggle) {
            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-open');
            });
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            });
        }
    }

    // Notification System
    function showNotification(message, type = 'success', duration = 3000) {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="d-flex align-items-center justify-content-between">
                <span>${message}</span>
                <button class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        container.appendChild(notification);
        
        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Auto remove
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }

    // Loading Overlay
    function showLoading(show = true) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }

    // Enhanced Global Search
    function initGlobalSearch() {
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performGlobalSearch(e.target.value);
                }, 300);
            });
        }
    }

    function performGlobalSearch(query) {
        if (query.length < 2) return;
        
        console.log('Searching for:', query);
        // Add your search logic here
        showNotification(`Searching for "${query}"...`, 'info', 1500);
    }

    // Enhanced Page Updates
    function updatePageTitle(title, subtitle) {
        const titleEl = document.getElementById('pageTitle');
        const subtitleEl = document.getElementById('pageSubtitle');
        
        if (titleEl) titleEl.textContent = title;
        if (subtitleEl) subtitleEl.textContent = subtitle;
    }

    // Data Refresh
    function initDataRefresh() {
        const refreshBtn = document.getElementById('refreshData');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                showLoading(true);
                showNotification('Refreshing data...', 'info', 1500);
                
                // Simulate data refresh
                setTimeout(() => {
                    showLoading(false);
                    showNotification('Data refreshed successfully!', 'success');
                    
                    // Reload current page data
                    const activePage = document.querySelector('.nav-link.active')?.getAttribute('data-page');
                    if (activePage) {
                        loadPage(activePage);
                    }
                }, 2000);
            });
        }
    }

    // Enhanced Analytics
    function generateAdvancedCharts() {
        // This would integrate with Chart.js or similar library
        console.log('Generating advanced charts...');
    }

    // Quick Stats Update
    function updateQuickStats() {
        // Real-time stats updates
        const stats = {
            onlineUsers: Math.floor(Math.random() * 50) + 10,
            todayListings: Math.floor(Math.random() * 20) + 5,
            todaySignups: Math.floor(Math.random() * 10) + 1
        };
        
        const onlineEl = document.getElementById('onlineUsers');
        const listingsEl = document.getElementById('todayListings');
        const signupsEl = document.getElementById('todaySignups');
        
        if (onlineEl) onlineEl.textContent = stats.onlineUsers;
        if (listingsEl) listingsEl.textContent = stats.todayListings;
        if (signupsEl) signupsEl.textContent = stats.todaySignups;
    }

    // Simple safe loadPage function
    if (!window.loadPage) {
        window.loadPage = function(page) {
            try {
                const contentDiv = document.getElementById('content');
                if (!contentDiv) return;
                
                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-page') === page) {
                        link.classList.add('active');
                    }
                });

                // Simple page loading
                if (page === 'dashboard') {
                    contentDiv.innerHTML = `
                        <div class="dashboard-container">
                            <h2><i class="fas fa-tachometer-alt"></i> StudX Analytics Dashboard</h2>
                            <div class="quick-actions">
                                <h5 class="mb-3"><i class="fas fa-bolt"></i> Quick Actions</h5>
                                <div class="d-flex flex-wrap">
                                    <a href="#" class="quick-action-btn" onclick="loadPage('sponsorship')">
                                        <i class="fas fa-star"></i> Manage Sponsorship
                                    </a>
                                    <a href="#" class="quick-action-btn" onclick="loadPage('analytics')">
                                        <i class="fas fa-chart-line"></i> View Analytics
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    setTimeout(() => updateQuickStats(), 200);
                } else if (page === 'sponsorship') {
                    loadSponsorshipPageContent();
                } else {
                    contentDiv.innerHTML = `<div class="page-content"><h2>${page.charAt(0).toUpperCase() + page.slice(1)}</h2><p>Loading ${page} content...</p></div>`;
                }
            } catch (error) {
                console.error('Error loading page:', error);
            }
        };
    }

    // Login system
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (username === 'admin' && password === 'admin123') {
            localStorage.setItem('isLoggedIn', 'true');
            
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            
            if (loginContainer) loginContainer.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            loadPage('dashboard');
            showNotification('Welcome back to StudX Admin!', 'success');
        } else {
            const errorMsg = document.querySelector('.error-message');
            if (errorMsg) {
                errorMsg.style.display = 'block';
                errorMsg.textContent = 'Invalid credentials. Please try again.';
            }
        }
    });

    // Check login on page load
    function checkLogin() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (isLoggedIn) {
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            
            if (loginContainer) loginContainer.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            loadPage('dashboard');
        }
    }

    // Initialize
    checkLogin();

    // Category-specific sponsorship management
    function getCategorySpecificSponsors(category) {
        // Get sponsorships from database or localStorage
        const localSponsors = JSON.parse(localStorage.getItem('sponsorships') || '[]');
        
        // Filter by category
        return localSponsors.filter(sponsor => {
            // Match sponsor type with category
            const categoryMapping = {
                'room': 'room',
                'rooms': 'room',
                'note': 'note', 
                'notes': 'note',
                'product': 'product',
                'products': 'product'
            };
            
            const expectedType = categoryMapping[category.toLowerCase()];
            return expectedType && sponsor.item_type === expectedType;
        });
    }

    // Create category-specific sponsorship query for main app
    window.getSponsorsForCategory = function(category) {
        return getCategorySpecificSponsors(category);
    };

    // Enhanced sponsorship with category filtering
    async function createCategorySpecificSponsorshipTable() {
        try {
            // This would be called in the main app to ensure proper category filtering
            // NOTE: Database function create_category_sponsorship_view is not available
            // Commenting out to avoid 404 errors
            /*
            const result = await supabase.rpc('create_category_sponsorship_view', {
                sql: `
                CREATE OR REPLACE VIEW category_sponsorships AS
                SELECT 
                    s.*,
                    CASE 
                        WHEN s.item_type = 'room' THEN 'room'
                        WHEN s.item_type = 'note' THEN 'note'
                        WHEN s.item_type = 'product' THEN 'product'
                        ELSE s.item_type
                    END as category
                FROM sponsorship_sequences s
                WHERE s.is_active = true
                ORDER BY s.slot ASC
                `
            });
            */
            console.log('Category-specific sponsorship view creation skipped (function not available)');
        } catch (error) {
            console.log('View creation skipped (likely already exists):', error.message);
        }
    }

    // Initialize category system
    createCategorySpecificSponsorshipTable();

    // Logout function
    function logout() {
        localStorage.removeItem('isLoggedIn');
        const loginContainer = document.getElementById('loginContainer');
        const mainContent = document.getElementById('mainContent');
        
        if (loginContainer) loginContainer.style.display = 'block';
        if (mainContent) mainContent.style.display = 'none';
        
        showNotification('Logged out successfully!', 'info');
    }

    // Make ALL functions globally accessible for onclick handlers
    window.loadPage = loadPage;
    window.confirmAddSponsor = confirmAddSponsor;
    window.openSponsorshipModal = openSponsorshipModal;
    window.searchItems = searchItems;
    window.clearAllSelections = clearAllSelections;
    window.showNotification = showNotification;
    window.logout = logout;
    
    // New sponsorship functions
    window.openAddSponsorModal = openAddSponsorModal;
    window.selectItemForSponsor = selectItemForSponsor;
    window.addSelectedSponsors = addSelectedSponsors;
    window.removeSponsor = removeSponsor;
    window.editSequence = editSequence;
    window.searchSponsorItems = searchSponsorItems;
    window.loadCurrentSponsoredItems = loadCurrentSponsoredItems;
    window.processSelectedSponsors = processSelectedSponsors;
    window.clearAllNewSelections = clearAllNewSelections;
    window.filterAvailableItems = filterAvailableItems;
    window.updateAddSponsorButton = updateAddSponsorButton;
    
    // Category-specific sponsorship functions for main app
    window.getSponsorsForCategory = getCategorySpecificSponsors;
    window.loadCategoryItems = async function(category) {
        try {
            // This function can be called from main StudX app
            const tableMap = {
                'rooms': 'rooms',
                'room': 'rooms', 
                'notes': 'notes',
                'note': 'notes',
                'products': 'products',
                'product': 'products'
            };
            
            const tableName = tableMap[category.toLowerCase()];
            if (!tableName) return [];
            
            // Get regular items
            const { data: items } = await supabase
                .from(tableName)
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            // Get sponsored items for this category only
            const itemType = tableName.slice(0, -1); // remove 's' to get singular
            const { data: sponsors } = await supabase
                .from('sponsorship_sequences')
                .select('*')
                .eq('item_type', itemType)
                .eq('is_active', true)
                .order('slot', { ascending: true });
            
            // Prioritize sponsored items
            if (sponsors && sponsors.length > 0) {
                const sponsoredIds = new Set(sponsors.map(s => s.item_id));
                const sponsoredItems = items.filter(item => sponsoredIds.has(item.id));
                const regularItems = items.filter(item => !sponsoredIds.has(item.id));
                
                // Sort sponsored items by slot
                sponsoredItems.sort((a, b) => {
                    const aSlot = sponsors.find(s => s.item_id === a.id)?.slot || 999;
                    const bSlot = sponsors.find(s => s.item_id === b.id)?.slot || 999;
                    return aSlot - bSlot;
                });
                
                // Mark sponsored items
                sponsoredItems.forEach(item => item.isSponsored = true);
                
                return [...sponsoredItems, ...regularItems];
            }
            
            return items || [];
            
        } catch (error) {
            console.error('Error loading category items:', error);
            
            // Fallback to localStorage
            const localSponsors = JSON.parse(localStorage.getItem('sponsorships') || '[]');
            const categorySponsors = localSponsors.filter(s => s.item_type === category.replace('s', ''));
            
            return categorySponsors.map(sponsor => ({
                id: sponsor.item_id,
                title: sponsor.title,
                isSponsored: true
            }));
        }
    };
    
    // Also make the main objects global for debugging
    window.supabase = supabase;
    
    // Make refresh functions globally accessible for onclick handlers
    window.refreshProductsAnalytics = refreshProductsAnalytics;
    window.refreshNotesAnalytics = refreshNotesAnalytics;
    window.refreshRoomsAnalytics = refreshRoomsAnalytics;
    
    // Make analytics render functions globally accessible
    window.renderProductsAnalytics = renderProductsAnalytics;
    window.renderNotesAnalytics = renderNotesAnalytics;
    window.renderRoomsAnalytics = renderRoomsAnalytics;
    
    // Make action handlers globally accessible
    window.viewProductDetails = viewProductDetails;
    window.editProduct = editProduct;
    window.viewNoteDetails = viewNoteDetails;
    window.editNote = editNote;
    window.viewRoomDetails = viewRoomDetails;
    window.editRoom = editRoom;
    
    // Make view tracking functions globally accessible
    window.trackView = trackView;
    window.getItemViews = getItemViews;
    window.ensureAnalyticsTable = ensureAnalyticsTable;

})(); // Close the async IIFE

</script>
</body>
</html>