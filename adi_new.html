<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudXchange Admin Panel - Complete Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ“</text></svg>">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 0.5rem;
            --border-radius-sm: 0.25rem;
            --border-radius-lg: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Login Container */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 3rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .login-logo .subtitle {
            color: var(--secondary-color);
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        /* Form Styles */
        .form-control {
            background: var(--light-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }

        .btn {
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-success:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            min-height: 100vh;
            background: #f8fafc;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: white;
            box-shadow: var(--shadow-lg);
            padding: 2rem 0;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 2rem;
            margin-bottom: 3rem;
            text-align: center;
        }

        .sidebar-header h3 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: block;
            padding: 1rem 2rem;
            color: var(--secondary-color);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .content-header h1 {
            margin: 0;
            color: var(--dark-color);
            font-size: 2rem;
            font-weight: 600;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .card-header {
            background: var(--light-color);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Item Selection Styles */
        .item-card {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .item-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .item-card.selected {
            border-color: var(--success-color);
            background: rgba(5, 150, 105, 0.1);
        }

        .item-card.selected::after {
            content: "âœ“";
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .item-card {
            position: relative;
        }

        /* Search and Filter */
        .search-filter-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Modal Enhancements */
        .modal-content {
            border-radius: var(--border-radius-lg);
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        /* Selection Summary */
        .selection-summary {
            background: var(--light-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .selected-item-tag {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            margin: 0.25rem;
        }

        .remove-selection {
            cursor: pointer;
            margin-left: 0.5rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .search-filter-container {
                flex-direction: column;
            }

            .search-input,
            .filter-select {
                min-width: 100%;
            }
        }

        /* Loading States */
        .spinner-sm {
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <div class="login-logo">
                <h1>ðŸŽ“ StudX</h1>
                <p class="subtitle">Admin Control Panel</p>
            </div>
            <form id="loginForm">
                <input type="text" id="username" class="form-control" placeholder="Username" required>
                <input type="password" id="password" class="form-control" placeholder="Password" required>
                <div class="mb-3">
                    <label>
                        <input type="checkbox" id="rememberMe" class="me-2">
                        Remember me
                    </label>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt"></i>
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>ðŸŽ“ StudX Admin</h3>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard" onclick="loadPage('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="products" onclick="loadPage('products')">
                        <i class="fas fa-box"></i>
                        Products
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="sponsorship" onclick="loadPage('sponsorship')">
                        <i class="fas fa-star"></i>
                        Sponsorship
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="users" onclick="loadPage('users')">
                        <i class="fas fa-users"></i>
                        Users
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="analytics" onclick="loadPage('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1 id="pageTitle">Dashboard</h1>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            
            <div id="content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Sponsorship Modal -->
    <div class="modal fade" id="sponsorshipModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-star"></i>
                        Add Multiple Items to Sponsorship
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Selection Summary -->
                    <div id="selectionSummary" class="selection-summary" style="display: none;">
                        <h6><i class="fas fa-check-circle text-success"></i> Selected Items:</h6>
                        <div id="selectedItems"></div>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="clearAllSelections()">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>

                    <!-- Search and Filter -->
                    <div class="search-filter-container">
                        <input type="text" 
                               id="itemSearch" 
                               class="form-control search-input" 
                               placeholder="ðŸ” Search items..." 
                               oninput="filterItems()">
                        <select id="typeFilter" class="form-select filter-select" onchange="filterItems()">
                            <option value="">All Types</option>
                            <option value="product">Products</option>
                            <option value="note">Notes</option>
                            <option value="user">Users</option>
                        </select>
                    </div>

                    <!-- Items Grid -->
                    <div id="itemsGrid" class="row">
                        <!-- Items will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" id="confirmAddMultipleSponsor" class="btn btn-success btn-lg" onclick="confirmAddMultipleSponsor()" disabled>
                        <i class="fas fa-star"></i> Add <span id="selectionCount">0</span> Items to Sponsorship
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Processing your request...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <script>
        // Global variables - accessible everywhere
        let supabase;
        let selectedItems = new Set(); // For multiple selection
        let allItems = []; // Cache for filtering
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // SUPABASE CONFIGURATION
        function initializeApp() {
            const SUPABASE_URL = 'https://vdpmumstdxgftaaxeacx.supabase.co';
            const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkcG11bXN0ZHhnZnRhYXhlYWN4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkwNjA4MiwiZXhwIjoyMDY3NDgyMDgyfQ.tdYV9te2jYq2ARdPiJi6mpkqfvg45YlfgZ2kXnhLVRs';
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
            
            // Check login status
            checkLogin();
            
            // Setup login form
            setupLoginForm();
        }

        // LOGIN SYSTEM
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        function checkLogin() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const rememberMe = localStorage.getItem('rememberMe');
            
            if (isLoggedIn === 'true' && rememberMe === 'true') {
                showAdminPanel();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            const loginScreen = document.getElementById('loginScreen');
            const adminPanel = document.getElementById('adminPanel');
            
            if (loginScreen) loginScreen.style.display = 'flex';
            if (adminPanel) adminPanel.style.display = 'none';
        }

        function showAdminPanel() {
            const loginScreen = document.getElementById('loginScreen');
            const adminPanel = document.getElementById('adminPanel');
            
            if (loginScreen) loginScreen.style.display = 'none';
            if (adminPanel) adminPanel.style.display = 'block';
            
            loadPage('dashboard');
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (username === 'admin' && password === 'studx123') {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('rememberMe', rememberMe.toString());
                
                showNotification('Login successful!', 'success');
                showAdminPanel();
            } else {
                showNotification('Invalid credentials!', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('rememberMe');
            showNotification('Logged out successfully!', 'success');
            showLoginScreen();
        }

        // NAVIGATION SYSTEM
        function loadPage(page) {
            const contentDiv = document.getElementById('content');
            const pageTitle = document.getElementById('pageTitle');
            
            // Update active navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('active');
                }
            });

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'products': 'Products Management',
                'sponsorship': 'Sponsorship Management',
                'users': 'Users Management',
                'analytics': 'Analytics'
            };
            
            if (pageTitle) {
                pageTitle.textContent = titles[page] || 'Dashboard';
            }

            // Load page content
            switch (page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'sponsorship':
                    loadSponsorship();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                default:
                    loadDashboard();
            }
        }

        // DASHBOARD
        function loadDashboard() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-box fa-3x text-primary mb-3"></i>
                                <h3 id="productCount">-</h3>
                                <p class="text-muted">Products</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-users fa-3x text-success mb-3"></i>
                                <h3 id="userCount">-</h3>
                                <p class="text-muted">Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-sticky-note fa-3x text-warning mb-3"></i>
                                <h3 id="noteCount">-</h3>
                                <p class="text-muted">Notes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-star fa-3x text-info mb-3"></i>
                                <h3 id="sponsorCount">-</h3>
                                <p class="text-muted">Sponsored</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-3">
                                    <button class="btn btn-primary" onclick="loadPage('products')">
                                        <i class="fas fa-plus"></i> Add Product
                                    </button>
                                    <button class="btn btn-success" onclick="openSponsorshipModal()">
                                        <i class="fas fa-star"></i> Add Sponsorship
                                    </button>
                                    <button class="btn btn-info" onclick="loadPage('users')">
                                        <i class="fas fa-user-plus"></i> Manage Users
                                    </button>
                                    <button class="btn btn-warning" onclick="loadPage('analytics')">
                                        <i class="fas fa-chart-bar"></i> View Analytics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load dashboard stats
            loadDashboardStats();
        }

        async function loadDashboardStats() {
            try {
                // Get counts from different tables
                const [products, users, notes, sponsors] = await Promise.all([
                    supabase.from('products').select('*', { count: 'exact' }),
                    supabase.from('users').select('*', { count: 'exact' }),
                    supabase.from('notes').select('*', { count: 'exact' }),
                    supabase.from('sponsorship_sequences').select('*', { count: 'exact' })
                ]);

                document.getElementById('productCount').textContent = products.count || 0;
                document.getElementById('userCount').textContent = users.count || 0;
                document.getElementById('noteCount').textContent = notes.count || 0;
                document.getElementById('sponsorCount').textContent = sponsors.count || 0;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // SPONSORSHIP SYSTEM
        function loadSponsorship() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-star"></i> Current Sponsorships</h5>
                        <button class="btn btn-success" onclick="openSponsorshipModal()">
                            <i class="fas fa-plus"></i> Add Multiple Items
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sponsorshipList">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading sponsorships...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadCurrentSponsorships();
        }

        async function loadCurrentSponsorships() {
            try {
                const { data: sponsorships, error } = await supabase
                    .from('sponsorship_sequences')
                    .select('*')
                    .order('slot', { ascending: true });

                if (error) throw error;

                const listDiv = document.getElementById('sponsorshipList');
                
                if (!sponsorships || sponsorships.length === 0) {
                    listDiv.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-star fa-3x mb-3"></i>
                            <p>No sponsorships found. Add some items to get started!</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="row">';
                sponsorships.forEach(sponsor => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title">${sponsor.title}</h6>
                                            <p class="card-text text-muted">
                                                <small>
                                                    <i class="fas fa-tag"></i> ${sponsor.type} 
                                                    | Slot: ${sponsor.slot}
                                                </small>
                                            </p>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeSponsor(${sponsor.id})">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                listDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading sponsorships:', error);
                document.getElementById('sponsorshipList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading sponsorships: ${error.message}
                    </div>
                `;
            }
        }

        async function removeSponsor(sponsorId) {
            if (!confirm('Are you sure you want to remove this sponsorship?')) return;

            try {
                const { error } = await supabase
                    .from('sponsorship_sequences')
                    .delete()
                    .eq('id', sponsorId);

                if (error) throw error;

                showNotification('Sponsorship removed successfully!', 'success');
                loadCurrentSponsorships();
            } catch (error) {
                console.error('Error removing sponsorship:', error);
                showNotification('Error removing sponsorship!', 'error');
            }
        }

        // MULTIPLE SELECTION SYSTEM
        async function openSponsorshipModal() {
            selectedItems.clear();
            updateSelectionSummary();
            
            const modal = new bootstrap.Modal(document.getElementById('sponsorshipModal'));
            modal.show();
            
            await loadAllItems();
        }

        async function loadAllItems() {
            try {
                showLoading('Loading items...');
                
                // Load all items from different tables
                const [products, notes, users] = await Promise.all([
                    supabase.from('products').select('id, title, price').limit(100),
                    supabase.from('notes').select('id, title, price').limit(100),
                    supabase.from('users').select('id, username, email').limit(100)
                ]);

                allItems = [
                    ...(products.data || []).map(item => ({ ...item, type: 'product' })),
                    ...(notes.data || []).map(item => ({ ...item, type: 'note' })),
                    ...(users.data || []).map(item => ({ ...item, type: 'user', title: item.username }))
                ];

                displayItems(allItems);
                hideLoading();
            } catch (error) {
                console.error('Error loading items:', error);
                hideLoading();
                showNotification('Error loading items!', 'error');
            }
        }

        function displayItems(items) {
            const grid = document.getElementById('itemsGrid');
            
            if (items.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>No items found matching your criteria.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            items.forEach(item => {
                const isSelected = selectedItems.has(`${item.type}-${item.id}`);
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="item-card ${isSelected ? 'selected' : ''}" 
                             onclick="toggleItemSelection('${item.type}', ${item.id}, '${item.title}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${item.title}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-tag"></i> ${item.type}
                                        ${item.price ? ` | $${item.price}` : ''}
                                        ${item.email ? ` | ${item.email}` : ''}
                                    </small>
                                </div>
                                <div class="ms-2">
                                    <i class="fas fa-${getTypeIcon(item.type)} text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function getTypeIcon(type) {
            const icons = {
                'product': 'box',
                'note': 'sticky-note',
                'user': 'user'
            };
            return icons[type] || 'circle';
        }

        function toggleItemSelection(type, id, title) {
            const key = `${type}-${id}`;
            
            if (selectedItems.has(key)) {
                selectedItems.delete(key);
            } else {
                selectedItems.add(key);
            }
            
            // Store item details for later use
            if (!window.selectedItemsData) {
                window.selectedItemsData = new Map();
            }
            
            if (selectedItems.has(key)) {
                window.selectedItemsData.set(key, { type, id, title });
            } else {
                window.selectedItemsData.delete(key);
            }
            
            updateSelectionSummary();
            displayItems(getFilteredItems()); // Refresh display to show selection state
        }

        function updateSelectionSummary() {
            const summaryDiv = document.getElementById('selectionSummary');
            const selectedDiv = document.getElementById('selectedItems');
            const countSpan = document.getElementById('selectionCount');
            const confirmBtn = document.getElementById('confirmAddMultipleSponsor');
            
            const count = selectedItems.size;
            
            if (count === 0) {
                summaryDiv.style.display = 'none';
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-star"></i> Select Items First';
            } else {
                summaryDiv.style.display = 'block';
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = `<i class="fas fa-star"></i> Add ${count} Items to Sponsorship`;
                
                let html = '';
                selectedItems.forEach(key => {
                    const data = window.selectedItemsData?.get(key);
                    if (data) {
                        html += `
                            <span class="selected-item-tag">
                                ${data.title}
                                <span class="remove-selection" onclick="toggleItemSelection('${data.type}', ${data.id}, '${data.title}')">
                                    Ã—
                                </span>
                            </span>
                        `;
                    }
                });
                selectedDiv.innerHTML = html;
            }
            
            countSpan.textContent = count;
        }

        function clearAllSelections() {
            selectedItems.clear();
            if (window.selectedItemsData) {
                window.selectedItemsData.clear();
            }
            updateSelectionSummary();
            displayItems(getFilteredItems());
        }

        function filterItems() {
            const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            
            const filtered = getFilteredItems(searchTerm, typeFilter);
            displayItems(filtered);
        }

        function getFilteredItems(searchTerm = '', typeFilter = '') {
            const search = searchTerm || document.getElementById('itemSearch')?.value.toLowerCase() || '';
            const type = typeFilter || document.getElementById('typeFilter')?.value || '';
            
            return allItems.filter(item => {
                const matchesSearch = !search || 
                    item.title.toLowerCase().includes(search) ||
                    item.type.toLowerCase().includes(search);
                
                const matchesType = !type || item.type === type;
                
                return matchesSearch && matchesType;
            });
        }

        // CONFIRM MULTIPLE SPONSORSHIP
        async function confirmAddMultipleSponsor() {
            if (selectedItems.size === 0) {
                showNotification('Please select at least one item!', 'warning');
                return;
            }

            try {
                showLoading('Adding items to sponsorship...');
                
                // Get next available slots
                const { data: existingSponsors } = await supabase
                    .from('sponsorship_sequences')
                    .select('slot')
                    .order('slot', { ascending: false })
                    .limit(1);

                let nextSlot = existingSponsors && existingSponsors.length > 0 
                    ? existingSponsors[0].slot + 1 
                    : 1;

                // Prepare items for insertion
                const itemsToInsert = [];
                selectedItems.forEach(key => {
                    const data = window.selectedItemsData?.get(key);
                    if (data) {
                        itemsToInsert.push({
                            type: data.type,
                            item_id: data.id,
                            title: data.title,
                            slot: nextSlot++,
                            created_at: new Date().toISOString()
                        });
                    }
                });

                // Insert all items
                const { error } = await supabase
                    .from('sponsorship_sequences')
                    .insert(itemsToInsert);

                if (error) throw error;

                // Close modal and refresh
                const modal = bootstrap.Modal.getInstance(document.getElementById('sponsorshipModal'));
                modal.hide();
                
                hideLoading();
                showNotification(`Successfully added ${itemsToInsert.length} items to sponsorship!`, 'success');
                
                // Refresh sponsorship page if we're on it
                if (document.querySelector('.nav-link[data-page="sponsorship"]')?.classList.contains('active')) {
                    loadCurrentSponsorships();
                }
                
                // Clear selections
                clearAllSelections();
                
            } catch (error) {
                console.error('Error adding sponsorships:', error);
                hideLoading();
                showNotification('Error adding items to sponsorship!', 'error');
            }
        }

        // OTHER PAGE LOADERS (simplified)
        function loadProducts() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-box"></i> Products Management</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Products management functionality would go here.</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Product
                        </button>
                    </div>
                </div>
            `;
        }

        function loadUsers() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users"></i> Users Management</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Users management functionality would go here.</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Add New User
                        </button>
                    </div>
                </div>
            `;
        }

        function loadAnalytics() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Analytics Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Analytics and reporting functionality would go here.</p>
                        <canvas id="analyticsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            `;
        }

        // UTILITY FUNCTIONS
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const content = overlay.querySelector('.loading-content p');
            if (content) content.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Make functions globally accessible for onclick handlers
        window.loadPage = loadPage;
        window.logout = logout;
        window.openSponsorshipModal = openSponsorshipModal;
        window.toggleItemSelection = toggleItemSelection;
        window.confirmAddMultipleSponsor = confirmAddMultipleSponsor;
        window.clearAllSelections = clearAllSelections;
        window.filterItems = filterItems;
        window.removeSponsor = removeSponsor;
    </script>
</body>
</html>
