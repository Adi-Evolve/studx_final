<!-- Add this script tag to any page where you want analytics tracking -->
<script src="/analytics-tracker.js"></script>

<!-- Or add this inline script to initialize analytics tracking -->
<script>
// Initialize StudX Analytics tracking
if (typeof window !== 'undefined') {
    // Create analytics tracking class
    class StudXAnalytics {
        constructor() {
            this.apiUrl = '/api/analytics';
            this.sessionId = this.generateSessionId();
            this.eventQueue = [];
            this.isOnline = navigator.onLine;
            this.startTime = Date.now();
            
            this.init();
        }

        generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        init() {
            // Track page view immediately
            this.trackPageView();
            
            // Track user interactions
            this.setupEventListeners();
            
            // Periodically flush events
            setInterval(() => this.flushEvents(), 5000);
            
            // Track page unload
            window.addEventListener('beforeunload', () => this.trackPageUnload());
        }

        setupEventListeners() {
            // Track clicks
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.tagName === 'A' || target.closest('a')) {
                    this.trackEvent('link_click', { url: target.href || target.closest('a').href });
                }
            });

            // Track API calls by intercepting fetch
            const originalFetch = window.fetch;
            window.fetch = async (...args) => {
                const startTime = Date.now();
                try {
                    const response = await originalFetch(...args);
                    const endTime = Date.now();
                    
                    // Track API call
                    if (args[0] && !args[0].includes('/api/analytics')) {
                        this.trackApiCall(args[0], 'GET', response.status, endTime - startTime);
                    }
                    
                    return response;
                } catch (error) {
                    const endTime = Date.now();
                    this.trackApiCall(args[0], 'GET', 0, endTime - startTime, error.message);
                    throw error;
                }
            };
        }

        trackPageView() {
            const event = {
                type: 'page_view',
                data: {
                    page: window.location.pathname,
                    title: document.title,
                    referrer: document.referrer,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                }
            };
            
            this.queueEvent(event);
        }

        trackApiCall(url, method, status, responseTime, errorMessage = null) {
            const event = {
                type: 'api_call',
                data: {
                    url,
                    method,
                    status,
                    responseTime,
                    errorMessage,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                }
            };
            
            this.queueEvent(event);
        }

        trackEvent(eventType, data) {
            const event = {
                type: 'user_event',
                data: {
                    eventType,
                    ...data,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                }
            };
            
            this.queueEvent(event);
        }

        trackPageUnload() {
            const sessionDuration = Date.now() - this.startTime;
            const event = {
                type: 'page_unload',
                data: {
                    page: window.location.pathname,
                    sessionDuration,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                }
            };
            
            // Send immediately with sendBeacon for reliability
            if (navigator.sendBeacon) {
                navigator.sendBeacon(this.apiUrl, JSON.stringify([event]));
            }
        }

        queueEvent(event) {
            this.eventQueue.push(event);
            
            // If queue is full, flush immediately
            if (this.eventQueue.length >= 10) {
                this.flushEvents();
            }
        }

        async flushEvents() {
            if (this.eventQueue.length === 0) return;
            
            const events = [...this.eventQueue];
            this.eventQueue = [];
            
            try {
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(events)
                });
                
                if (!response.ok) {
                    console.warn('Analytics tracking failed:', response.status);
                    // Re-queue events if they failed to send
                    this.eventQueue.unshift(...events);
                }
            } catch (error) {
                console.warn('Analytics tracking error:', error);
                // Re-queue events if they failed to send
                this.eventQueue.unshift(...events);
            }
        }
    }

    // Initialize analytics tracking
    window.studxAnalytics = new StudXAnalytics();
}
</script>
