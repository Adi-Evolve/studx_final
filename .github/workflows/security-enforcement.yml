name: ğŸ”’ Repository Security Enforcement
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  issues:
    types: [opened, edited]
  
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-check:
    name: ğŸ›¡ï¸ Security Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸš¨ Verify Repository Owner
      run: |
        echo "ğŸ” Verifying repository access..."
        if [ "${{ github.actor }}" != "Adi-Evolve" ]; then
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸš« ERROR: Direct push to main branch not allowed for user: ${{ github.actor }}"
            echo "â„¹ï¸  Only Adi-Evolve can push directly to main branch"
            exit 1
          fi
        fi
        echo "âœ… Repository access verified"

    - name: ğŸ” Secret Scanning
      run: |
        echo "ğŸ” Scanning for exposed secrets..."
        
        # Check for common secret patterns
        if grep -r "sk_live_" . --exclude-dir=.git || \
           grep -r "pk_live_" . --exclude-dir=.git || \
           grep -r "eyJ[A-Za-z0-9]" . --exclude-dir=.git | grep -v "\.md" || \
           grep -r "rzp_live_" . --exclude-dir=.git || \
           grep -r "SUPABASE.*eyJ" . --exclude-dir=.git; then
          echo "ğŸš¨ CRITICAL: Potential secrets found in repository!"
          echo "ğŸ”’ Please remove all hardcoded secrets and use environment variables"
          exit 1
        fi
        echo "âœ… No secrets detected"

    - name: ğŸ›¡ï¸ File Security Check
      run: |
        echo "ğŸ” Checking for prohibited files..."
        
        # Check for admin/sensitive files
        prohibited_files=(
          "adi.html"
          "admin-panel*.html"
          "test-api.html" 
          "test-analytics.html"
          "*credential*"
          "*secret*"
          "enhanced-admin*.js"
          "diagnose_*.js"
        )
        
        found_prohibited=false
        for pattern in "${prohibited_files[@]}"; do
          if find . -name "$pattern" -not -path "./.git/*" | grep -q .; then
            echo "ğŸš« BLOCKED: Prohibited file pattern found: $pattern"
            find . -name "$pattern" -not -path "./.git/*"
            found_prohibited=true
          fi
        done
        
        if [ "$found_prohibited" = true ]; then
          echo "ğŸš¨ Security violation: Prohibited files detected"
          exit 1
        fi
        echo "âœ… No prohibited files found"

    - name: ğŸ“Š Security Score Validation
      run: |
        echo "ğŸ” Running security validation..."
        if [ -f "validate-security.js" ]; then
          node validate-security.js
          if [ $? -ne 0 ]; then
            echo "ğŸš¨ Security validation failed"
            exit 1
          fi
        fi
        echo "âœ… Security validation passed"

    - name: ğŸ”’ Branch Protection Reminder
      if: github.event_name == 'pull_request'
      run: |
        echo "â„¹ï¸  SECURITY REMINDER:"
        echo "ğŸ“‹ This PR requires approval from repository owner (Adi-Evolve)"
        echo "ğŸ”’ Main branch is protected - no direct pushes allowed"
        echo "ğŸ›¡ï¸ All security checks must pass before merge"

  dependency-security:
    name: ğŸ” Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ” Audit Dependencies
      run: |
        echo "ğŸ” Auditing npm dependencies for vulnerabilities..."
        npm audit --audit-level=moderate
        if [ $? -ne 0 ]; then
          echo "ğŸš¨ Security vulnerabilities found in dependencies"
          echo "ğŸ”§ Please run 'npm audit fix' to resolve issues"
          exit 1
        fi
        echo "âœ… No security vulnerabilities found"

  access-control:
    name: ğŸš« Access Control Enforcement  
    runs-on: ubuntu-latest
    if: github.actor != 'Adi-Evolve'
    
    steps:
    - name: ğŸ”’ Enforce Access Restrictions
      run: |
        echo "ğŸ” User: ${{ github.actor }}"
        echo "ğŸ“‹ Event: ${{ github.event_name }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref }}"
        
        # Log access attempt
        echo "ğŸ“Š Access attempt logged: ${{ github.actor }} attempted ${{ github.event_name }} on $(date)"
        
        # Allow only specific actions for non-owners
        allowed_events=("pull_request" "issues" "issue_comment")
        
        if [[ ! " ${allowed_events[@]} " =~ " ${{ github.event_name }} " ]]; then
          echo "ğŸš« ACCESS DENIED: Action '${{ github.event_name }}' not permitted"
          echo "â„¹ï¸  Allowed actions: pull_request, issues, issue_comment"
          echo "ğŸ‘¤ Only repository owner (Adi-Evolve) has full access"
          exit 1
        fi
        
        echo "âœ… Access granted for permitted action"
